<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jhat.st_wcs_align &mdash; jhat 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/jhat.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/jhat.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Primary Contributors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">jhat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jhat.st_wcs_align</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jhat.st_wcs_align</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Apr 21 14:32:42 2022</span>

<span class="sd">@author: arest, bhilbert, mcorrenti, acanipe, jpierel</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">copy</span>
<span class="c1">#from jwst.tweakreg import TweakRegStep</span>
<span class="kn">import</span> <span class="nn">tweakreg_hack</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">datamodels</span>

<span class="kn">from</span> <span class="nn">.simple_jwst_phot</span> <span class="kn">import</span> <span class="n">jwst_photclass</span><span class="p">,</span><span class="n">hst_photclass</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;st_wcs_align&#39;</span><span class="p">]</span>

<span class="n">plot_style</span><span class="o">=</span><span class="p">{}</span>
<span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mi">5</span> <span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">}</span>
<span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mi">5</span> <span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}</span>
<span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">initplot</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize4subplot</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">sp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">xfigsize</span><span class="o">=</span><span class="n">figsize4subplot</span><span class="o">*</span><span class="n">ncols</span>
    <span class="n">yfigsize</span><span class="o">=</span><span class="n">figsize4subplot</span><span class="o">*</span><span class="n">nrows</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xfigsize</span><span class="p">,</span><span class="n">yfigsize</span><span class="p">))</span>
    <span class="n">counter</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span><span class="s1">&#39;fontsize&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span><span class="s1">&#39;fontsize&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">(),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">(),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>


<span class="c1"># These are the info plots to check out dx, dy for good and bad detections</span>
<span class="k">def</span> <span class="nf">infoplots</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs_good</span><span class="p">,</span><span class="n">dy_plotlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dx_plotlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">sp</span><span class="o">=</span><span class="n">initplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;dmag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ixs_cut</span> <span class="o">=</span> <span class="n">AnotB</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span><span class="p">,</span><span class="n">ixs_good</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_good</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cut</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span><span class="p">))</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_plotlim</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;dmag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>


    
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dx in pixels&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_plotlim</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dy in pixels&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;dmag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dmag&#39;</span><span class="p">)</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_good</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;roundness1&#39;</span><span class="p">)</span>
    
    <span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="c1"># plot the rotated dx or dy versus the original one</span>
<span class="k">def</span> <span class="nf">plot_rotated</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                 <span class="n">histotable</span><span class="p">,</span>
                 <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">d_col_rot</span><span class="o">=</span><span class="s1">&#39;d_rot_tmp&#39;</span><span class="p">,</span>
                 <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">histolim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                 <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">initplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="c1"># Get the limits for the plots</span>
    <span class="c1"># the maximum limits are passed with histolim</span>
    <span class="c1"># however, if the all data is within the limits, then</span>
    <span class="c1"># shrink the limits accordingly</span>
    <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">])</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">minval</span><span class="o">&gt;</span><span class="n">histolim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">histolim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">minval</span>
    <span class="k">if</span> <span class="n">maxval</span><span class="o">&lt;</span><span class="n">histolim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">histolim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">maxval</span>
    <span class="c1"># add a buffer to the min and max values</span>
    <span class="n">histolim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-=</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">maxval</span><span class="o">-</span><span class="n">minval</span><span class="p">)</span>
    <span class="n">histolim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">maxval</span><span class="o">-</span><span class="n">minval</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">ylim</span><span class="o">=</span><span class="n">histolim</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">ylim</span><span class="o">=</span><span class="n">histolim</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1"> [pixels]&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    
    <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bin_weights_flag</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                                                <span class="n">weights</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;__weights&#39;</span><span class="p">],</span>
                                                <span class="n">xlim</span><span class="o">=</span><span class="n">histolim</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span><span class="n">xlim</span><span class="o">=</span><span class="n">histolim</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">apply_rolling_gaussian</span><span class="p">:</span>
            <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;bincenter&#39;</span><span class="p">,</span><span class="s1">&#39;histosum&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rotated </span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#sp[spi[1]].get_legend().remove()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">initial_dxdy_plot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span> <span class="n">ixs_use</span><span class="p">,</span> <span class="n">ixs_notuse</span><span class="p">,</span> 
                      <span class="n">plots_dxdy_delta_pix_ylim</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                      <span class="n">refcat_mainfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_mainfilter_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_maincolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">d2d_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dmag_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Nbright</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">delta_mag_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">sp</span> <span class="o">=</span> <span class="n">initplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dx_median</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">dy_median</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dx median: </span><span class="si">{</span><span class="n">dx_median</span><span class="si">}</span><span class="se">\n</span><span class="s1">dy median: </span><span class="si">{</span><span class="n">dy_median</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
 
    <span class="c1"># these are the general limits for the y-axis for the dx/dy plots</span>
    <span class="n">dy_plotlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">dy_median</span><span class="o">-</span><span class="n">plots_dxdy_delta_pix_ylim</span><span class="p">,</span><span class="n">dy_median</span><span class="o">+</span><span class="n">plots_dxdy_delta_pix_ylim</span><span class="p">)</span>
    <span class="n">dx_plotlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx_median</span><span class="o">-</span><span class="n">plots_dxdy_delta_pix_ylim</span><span class="p">,</span><span class="n">dx_median</span><span class="o">+</span><span class="n">plots_dxdy_delta_pix_ylim</span><span class="p">)</span>


    <span class="c1"># plot the residuals</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Initial cut: d2d_max=</span><span class="si">{</span><span class="n">d2d_max</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">dmag_max=</span><span class="si">{</span><span class="n">dmag_max</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">title_Nbright</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Nbright=</span><span class="si">{</span><span class="n">Nbright</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">title_deltamag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;delta_mag_lim=</span><span class="si">{</span><span class="n">delta_mag_lim</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dx [pixel]&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_plotlim</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_plotlim</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dy [pixel]&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y [pixel]&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="n">title_Nbright</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title_deltamag</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;mag - </span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title_deltamag</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_use</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;mag - </span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dxdy_plot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs_selected</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">refcat_mainfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_mainfilter_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_maincolor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sp</span><span class="o">=</span><span class="n">initplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">dx_median</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">dy_median</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="n">dlim_big</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="c1">#dlim_small= 1</span>
    <span class="n">dx_ylim_big</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx_median</span><span class="o">-</span><span class="n">dlim_big</span><span class="p">,</span><span class="n">dx_median</span><span class="o">+</span><span class="n">dlim_big</span><span class="p">)</span>
    <span class="n">dy_ylim_big</span> <span class="o">=</span> <span class="p">(</span><span class="n">dy_median</span><span class="o">-</span><span class="n">dlim_big</span><span class="p">,</span><span class="n">dy_median</span><span class="o">+</span><span class="n">dlim_big</span><span class="p">)</span>
    <span class="c1">#dx_ylim_small = (dx_median-dlim_small,dx_median+dlim_small)</span>
    <span class="c1">#dy_ylim_small = (dy_median-dlim_small,dy_median+dlim_small)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">refcat_mainfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">refcat_mainfilter</span> <span class="ow">in</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_mainfilter</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning! cannot make plot with reference filter </span><span class="si">{</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">, since it is not a column in the table&#39;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span> <span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;do_not_use_data&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ixs_cut</span> <span class="o">=</span> <span class="n">AnotB</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span><span class="p">,</span><span class="n">ixs_selected</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span> <span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;cut_data&#39;</span><span class="p">])</span>
        
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_ylim_big</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dx in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_ylim_big</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dy in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>

    <span class="p">(</span><span class="n">dx_min</span><span class="p">,</span><span class="n">dx_max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">dx_ylim_small</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx_min</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">dx_max</span> <span class="o">-</span> <span class="n">dx_min</span><span class="p">),</span> <span class="n">dx_max</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">dx_max</span> <span class="o">-</span> <span class="n">dx_min</span><span class="p">))</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_ylim_small</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dx in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dx_ylim_small</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dx in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>

    <span class="p">(</span><span class="n">dy_min</span><span class="p">,</span><span class="n">dy_max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">dy_ylim_small</span> <span class="o">=</span> <span class="p">(</span><span class="n">dy_min</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">dy_max</span> <span class="o">-</span> <span class="n">dy_min</span><span class="p">),</span> <span class="n">dy_max</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">dy_max</span> <span class="o">-</span> <span class="n">dy_min</span><span class="p">))</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_ylim_small</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dy in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="n">dy_ylim_small</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;dy in pixels&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>

    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;mag - </span><span class="si">{</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_maincolor</span><span class="p">,</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcat_mainfilter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_selected</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_style</span><span class="p">[</span><span class="s1">&#39;good_data&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_info_for_maxval</span><span class="p">(</span><span class="n">histotable</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;bincenter&#39;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;histo&#39;</span><span class="p">,</span><span class="n">use_firstindex_if_multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,):</span>
    <span class="c1"># get the max value of the histogram, and its associated bin</span>
    <span class="c1">#print(histo)</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">xcol</span><span class="p">])</span>
    <span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">ycol</span><span class="p">])</span>
    <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    
    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span>
    <span class="n">ixs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yvals</span><span class="o">==</span><span class="n">maxval</span><span class="p">)</span>
    <span class="n">multiple_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;BUUUUGGGG!!!!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_firstindex_if_multiple</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;More than one indices </span><span class="si">{</span><span class="n">ixs_max</span><span class="si">}</span><span class="s1"> for maxval=</span><span class="si">{</span><span class="n">maxval</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#print(f&#39;\nWARNING!! More than one indices {ixs_max} for maxval={maxval}!&#39;)</span>
        <span class="n">multiple_max</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">ix_best</span><span class="o">=</span><span class="n">ixs_max</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">multiple_max</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">ix_best</span><span class="o">=</span><span class="n">ixs_max</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># return ()</span>
    
    <span class="c1"># get the (rough) fwhm of the peak</span>
    <span class="n">ix_minus</span> <span class="o">=</span> <span class="n">ix_best</span><span class="o">-</span><span class="mi">1</span> 
    <span class="k">if</span> <span class="n">ix_minus</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">ix_minus</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ix_plus</span> <span class="o">=</span> <span class="n">ix_best</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">ix_plus</span><span class="o">&gt;</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">ix_plus</span><span class="o">=</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">ix_minus</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yvals</span><span class="p">[</span><span class="n">ix_minus</span><span class="p">]</span><span class="o">&lt;=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">yvals</span><span class="p">[</span><span class="n">ix_best</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="n">ix_minus</span><span class="o">-=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">ix_plus</span><span class="o">&lt;</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yvals</span><span class="p">[</span><span class="n">ix_plus</span><span class="p">]</span><span class="o">&lt;=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">yvals</span><span class="p">[</span><span class="n">ix_best</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="n">ix_plus</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">ix_plus</span><span class="o">==</span><span class="n">ix_minus</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: problems getting FWHM!!! Setting it to binsize&#39;</span><span class="p">)</span>
        <span class="n">ix_minus</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ix_plus</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="n">ix_plus</span><span class="p">]</span><span class="o">-</span><span class="n">xvals</span><span class="p">[</span><span class="n">ix_minus</span><span class="p">]</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="n">ix_best</span><span class="p">],</span><span class="n">yvals</span><span class="p">[</span><span class="n">ix_best</span><span class="p">],</span><span class="n">ix_best</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">multiple_max</span><span class="p">)</span>

<span class="c1"># straight line.</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">val</span><span class="o">*</span><span class="n">slope</span><span class="o">+</span><span class="n">intercept</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_binmax_for_slope</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                          <span class="n">Naxis_px</span><span class="p">,</span>
                          <span class="n">gaussian_sigma</span><span class="p">,</span>
                          <span class="n">windowsize</span><span class="p">,</span>
                          <span class="n">halfwindowsize</span><span class="p">,</span>
                          <span class="n">rot_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">d_col_rot</span><span class="o">=</span><span class="s1">&#39;d_rot_tmp&#39;</span><span class="p">,</span>
                          <span class="n">binsize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                          <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">showplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>

    <span class="n">intercept</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Naxis_px</span> <span class="o">*</span> <span class="n">slope</span>
        
    <span class="c1">#phot.t.loc[ixs,d_col_rot] = phot.t.loc[ixs,d_col] - f(phot.t.loc[ixs,col],slope,intercept)</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">d_col_rot</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">d_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">)</span>

    <span class="c1"># get the histogram</span>
    <span class="n">d_rotated</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">]</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d_rotated</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d_rotated</span><span class="p">)</span><span class="o">+</span><span class="n">binsize</span><span class="p">,</span><span class="n">binsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bin_weights_flag</span><span class="p">:</span>
        <span class="n">histo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">d_rotated</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;__weights&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">histo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">d_rotated</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

    <span class="n">histotable</span><span class="o">=</span><span class="n">pdastroclass</span><span class="p">()</span>            
    <span class="k">if</span> <span class="n">apply_rolling_gaussian</span><span class="p">:</span>
        <span class="c1"># extend teh bins by +- halfwindowsize, since the kernel has the size windowsize. If this </span>
        <span class="c1"># extension is not done, then the values at the edges within halfwindowsize are ignored!</span>
        <span class="n">binmin</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">binsize</span><span class="o">-</span><span class="n">halfwindowsize</span><span class="o">*</span><span class="n">binsize</span>
        <span class="n">bins_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">binmin</span><span class="p">,</span><span class="n">binmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">halfwindowsize</span><span class="p">)</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span><span class="n">binsize</span><span class="p">)</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;bincenter&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bins_extended</span>

        <span class="c1"># fill in the histogram values: make sure the get added +halfwindowsize into the table, </span>
        <span class="c1"># since the bins got extended! The values outside are set to 0.0</span>
        <span class="n">dataindices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">halfwindowsize</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">halfwindowsize</span><span class="p">)</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;histo&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataindices</span><span class="p">,</span><span class="s1">&#39;histo&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># TEST1 and TEST2 should be the same array (within floating point accuracy)</span>
        <span class="c1">#print(&#39;TEST1&#39;,histo[1][:-1]+0.5*binsize)</span>
        <span class="c1">#print(&#39;TEST2&#39;,histotable.t.loc[dataindices,&#39;bincenter&#39;])</span>
        <span class="c1">#print(&#39;TEST length&#39;,len(histo[1][:-1]+0.5*binsize),len(histo[0]),len(dataindices))</span>

        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;histosum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;histo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">windowsize</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">win_type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">gaussian_sigma</span><span class="p">)</span>
        <span class="n">ix_nan</span> <span class="o">=</span> <span class="n">histotable</span><span class="o">.</span><span class="n">ix_is_null</span><span class="p">(</span><span class="s1">&#39;histosum&#39;</span><span class="p">)</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix_nan</span><span class="p">,</span><span class="s1">&#39;histosum&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="c1">#sp=initplot(1,1)</span>
        <span class="c1">#histotable.t.plot(&#39;bincenter&#39;,&#39;histo&#39;,ax=sp[0],color=&#39;blue&#39;)</span>
        <span class="c1">#histotable.t.plot(&#39;bincenter&#39;,&#39;histosum&#39;,ax=sp[0],color=&#39;red&#39;)</span>
        <span class="c1">#histotable.write()</span>

        <span class="p">(</span><span class="n">bincenter4maxval</span><span class="p">,</span><span class="n">maxval</span><span class="p">,</span><span class="n">index_maxval</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">multiple_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">find_info_for_maxval</span><span class="p">(</span><span class="n">histotable</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;histosum&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Note that the bincenter is the value in the bins (left edge of the bin) + the half of the binsize</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;bincenter&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">binsize</span>
        <span class="n">histotable</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;histo&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="p">(</span><span class="n">bincenter4maxval</span><span class="p">,</span><span class="n">maxval</span><span class="p">,</span><span class="n">index_maxval</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">multiple_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">find_info_for_maxval</span><span class="p">(</span><span class="n">histotable</span><span class="p">)</span>

    <span class="c1"># Save the results</span>
    <span class="k">if</span> <span class="n">rot_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rot_results</span><span class="o">.</span><span class="n">newrow</span><span class="p">({</span><span class="s1">&#39;slope&#39;</span><span class="p">:</span><span class="n">slope</span><span class="p">,</span>
                            <span class="s1">&#39;intercept&#39;</span><span class="p">:</span><span class="n">intercept</span><span class="p">,</span>
                            <span class="s1">&#39;maxval&#39;</span><span class="p">:</span><span class="n">maxval</span><span class="p">,</span>
                            <span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="n">index_maxval</span><span class="p">,</span>
                            <span class="s1">&#39;d_bestguess&#39;</span><span class="p">:</span><span class="n">bincenter4maxval</span><span class="p">,</span>
                            <span class="s1">&#39;fwhm&#39;</span><span class="p">:</span><span class="n">fwhm</span><span class="p">,</span>
                            <span class="s1">&#39;multimax&#39;</span><span class="p">:</span><span class="n">multiple_max</span>
                            <span class="p">})</span>
    <span class="c1"># plot it if wanted</span>
    <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">plot_rotated</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span>
                     <span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                     <span class="n">histotable</span><span class="p">,</span>
                     <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="n">apply_rolling_gaussian</span><span class="p">,</span>
                     <span class="n">d_col_rot</span><span class="o">=</span><span class="n">d_col_rot</span><span class="p">,</span>
                     <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                     <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                     <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
                     <span class="n">spi</span><span class="o">=</span><span class="n">spi</span><span class="p">,</span>
                     <span class="n">histolim</span> <span class="o">=</span> <span class="p">[</span><span class="n">bincenter4maxval</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="n">bincenter4maxval</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span>
                     <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;slope:</span><span class="si">{</span><span class="n">slope</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rotate_d_and_find_binmax</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                             <span class="n">Naxis_px</span><span class="p">,</span> <span class="c1"># Nx or Ny, depending on col</span>
                             <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">gaussian_sigma_px</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span>
                             <span class="n">d_col_rot</span><span class="o">=</span><span class="s1">&#39;d_rot_tmp&#39;</span><span class="p">,</span>
                             <span class="n">binsize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                             <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">slope_min</span><span class="o">=-</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> <span class="c1"># </span>
                             <span class="n">slope_max</span><span class="o">=</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> <span class="c1"># </span>
                             <span class="n">slope_stepsize</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2048</span><span class="p">,</span>
                             <span class="n">showplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;########################</span><span class="se">\n</span><span class="s1">### rotate </span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1"> versus </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">rot_results</span> <span class="o">=</span> <span class="n">pdastroclass</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">bin_weights_flag</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;weighting with flux!&#39;</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;__weights&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;__weights&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="c1"># if rolling gaussian: get window sizes!</span>
    <span class="k">if</span> <span class="n">apply_rolling_gaussian</span><span class="p">:</span>
        <span class="c1"># get the half window size for gaussian kernel in integer bins </span>
        <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="n">gaussian_sigma_px</span><span class="o">/</span><span class="n">binsize</span>
        <span class="c1"># kernel window size: 3*sigma half width</span>
        <span class="n">windowsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">gaussian_sigma</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># make sure the window size is uneven, so that the peak is centered!</span>
        <span class="k">if</span> <span class="n">windowsize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">windowsize</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">halfwindowsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">windowsize</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Applying rolling gaussian:</span><span class="se">\n</span><span class="s1">gaussian_sigma_px=</span><span class="si">{</span><span class="n">gaussian_sigma_px</span><span class="si">}</span><span class="s1">, binsize=</span><span class="si">{</span><span class="n">binsize</span><span class="si">}</span><span class="s1">, gaussian_sigma(bins)=</span><span class="si">{</span><span class="n">gaussian_sigma</span><span class="si">}</span><span class="s1">, windowsize(bins)=</span><span class="si">{</span><span class="n">windowsize</span><span class="si">}</span><span class="s1"> halfwindowsize(bins)=</span><span class="si">{</span><span class="n">halfwindowsize</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Loop through the slopes</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;slope min: </span><span class="si">{</span><span class="n">slope_min</span><span class="si">}</span><span class="s1">, slope max: </span><span class="si">{</span><span class="n">slope_max</span><span class="si">}</span><span class="s1">, slope stepsize: slope_stepsize&#39;</span><span class="p">)</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">slope_min</span><span class="p">,</span><span class="n">slope_max</span><span class="p">,</span><span class="n">slope_stepsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;iteration </span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span><span class="si">}</span><span class="s1">: slope = </span><span class="si">{</span><span class="n">slopes</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">find_binmax_for_slope</span><span class="p">(</span><span class="n">slopes</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                              <span class="n">Naxis_px</span><span class="p">,</span>
                              <span class="n">gaussian_sigma</span><span class="p">,</span>
                              <span class="n">windowsize</span><span class="p">,</span>
                              <span class="n">halfwindowsize</span><span class="p">,</span>
                              <span class="n">rot_results</span><span class="o">=</span><span class="n">rot_results</span><span class="p">,</span>
                              <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="n">apply_rolling_gaussian</span><span class="p">,</span>
                              <span class="n">d_col_rot</span><span class="o">=</span><span class="n">d_col_rot</span><span class="p">,</span>
                              <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                              <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                              <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">,</span>
                              <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># print the results        </span>
    <span class="n">rot_results</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    
    <span class="c1"># find the best rotation</span>
    <span class="n">maxmaxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;maxval&#39;</span><span class="p">])</span>
    <span class="n">ixs_maxmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;maxval&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">maxmaxval</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_maxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;BUUUUGGGG!!!!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_maxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1">#print(f&#39;\nWARNING!! more than one bin with maxvalue={maxmaxval}!&#39;)</span>
        <span class="n">best_index</span><span class="o">=</span><span class="n">ixs_maxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_index</span><span class="o">=</span><span class="n">ixs_maxmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;####BEST:&#39;</span><span class="p">)</span>
    <span class="n">rot_results</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">best_index</span><span class="p">])</span>
    
    <span class="c1"># make the summary plots</span>
    <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">initplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span><span class="s1">&#39;maxval&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;histogran peak value&#39;</span><span class="p">)</span>
        <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span><span class="s1">&#39;d_bestguess&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    
        <span class="n">find_binmax_for_slope</span><span class="p">(</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                              <span class="n">Naxis_px</span><span class="p">,</span>
                              <span class="n">gaussian_sigma</span><span class="p">,</span>
                              <span class="n">windowsize</span><span class="p">,</span>
                              <span class="n">halfwindowsize</span><span class="p">,</span>
                              <span class="n">rot_results</span><span class="o">=</span><span class="n">rot_results</span><span class="p">,</span>
                              <span class="n">apply_rolling_gaussian</span><span class="o">=</span><span class="n">apply_rolling_gaussian</span><span class="p">,</span>
                              <span class="n">d_col_rot</span><span class="o">=</span><span class="n">d_col_rot</span><span class="p">,</span>
                              <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                              <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                              <span class="n">showplots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                              <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
                              <span class="n">spi</span><span class="o">=</span><span class="n">spi</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">rot_results</span><span class="p">,</span><span class="n">best_index</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sigmacut_d_rot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span>
                   <span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                   <span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">d_rot_bestguess</span><span class="p">,</span>
                   <span class="n">rough_cut_px</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span> <span class="c1">#This is the first rough cut:  get rid of everything d_rot_bestguess+-rough_cut_px</span>
                   <span class="n">d_col_rot</span><span class="o">=</span><span class="s1">&#39;d_rot_tmp&#39;</span><span class="p">,</span>
                   <span class="n">binsize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                   <span class="n">Nsigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                   <span class="n">percentile_cut_firstiteration</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
                   <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">showplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

    <span class="c1">### recover the slope and intercept of the best binning</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">d_col_rot</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">d_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">)</span>
    
    <span class="c1"># Now make the rough cut! only keep data for with dx_rotated within  d_rot_bestguess+-rough_cut_px</span>
    <span class="n">ixs_roughcut</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">d_rot_bestguess</span><span class="o">-</span><span class="n">rough_cut_px</span><span class="p">,</span><span class="n">d_rot_bestguess</span><span class="o">+</span><span class="n">rough_cut_px</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs</span><span class="p">)</span>
    <span class="c1">#d_rotated = phot.t.loc[ixs,d_col_rot]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">####################</span><span class="se">\n</span><span class="s1">### d_rotated cut (Nsigma=</span><span class="si">{</span><span class="n">Nsigma</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Nsigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Nsigma</span><span class="o">==</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="c1"># don&#39;t do percentile cut if there are no iterations!</span>
        <span class="n">percentile_cut_firstiteration</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#ixs_clean4average = phot_clear.ix_inrange(d_col,0,3,indices=ixs_clear_cut)</span>
    <span class="n">phot</span><span class="o">.</span><span class="n">calcaverage_sigmacutloop</span><span class="p">(</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_roughcut</span><span class="p">,</span><span class="n">Nsigma</span><span class="o">=</span><span class="n">Nsigma</span><span class="p">,</span><span class="n">percentile_cut_firstiteration</span><span class="o">=</span><span class="n">percentile_cut_firstiteration</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">statstring</span><span class="p">())</span>
    <span class="n">ixs_cut</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">statparams</span><span class="p">[</span><span class="s1">&#39;ix_good&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;3-sigma cut: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cut</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_roughcut</span><span class="p">)</span><span class="si">}</span><span class="s1"> left</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;mean = </span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">statparams</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> px, stdev = </span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">statparams</span><span class="p">[</span><span class="s2">&quot;stdev&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> px&#39;</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">AnotB</span><span class="p">(</span><span class="n">ixs_roughcut</span><span class="p">,</span><span class="n">ixs_cut</span><span class="p">)]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span> <span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cut</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                                 <span class="n">ms</span><span class="o">=</span><span class="mi">5</span> <span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1"> [pixels]&#39;</span><span class="p">,</span>
                                 <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    
        <span class="c1"># set the appropriate y-axis limits</span>
        <span class="p">(</span><span class="n">ylim_min</span><span class="p">,</span><span class="n">ylim_max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_roughcut</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_roughcut</span><span class="p">,</span><span class="n">d_col_rot</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ylim_min</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">ylim_max</span><span class="o">-</span><span class="n">ylim_min</span><span class="p">)</span>
        <span class="n">ylim_max</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">ylim_max</span><span class="o">-</span><span class="n">ylim_min</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">spi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim_min</span><span class="p">,</span><span class="n">ylim_max</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span> 

    <span class="k">return</span><span class="p">(</span><span class="n">ixs_cut</span><span class="p">,</span><span class="n">ixs_roughcut</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">histogram_cut</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                  <span class="n">Naxis_px</span><span class="p">,</span> <span class="c1"># Nx or Ny, depending on col</span>
                  <span class="n">d_col_rot</span><span class="o">=</span><span class="s1">&#39;d_rot_tmp&#39;</span><span class="p">,</span>
                  <span class="n">binsize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                  <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">slope_min</span><span class="o">=-</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> <span class="c1"># </span>
                  <span class="n">slope_max</span><span class="o">=</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> <span class="c1"># </span>
                  <span class="n">slope_stepsize</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2048</span><span class="p">,</span>
                  <span class="c1">#This is the first rough cut:  get rid of everything d_rot_bestguess+-Nfwhm*fwhm,</span>
                  <span class="n">Nfwhm</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                  <span class="n">rough_cut_px_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">rough_cut_px_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">Nsigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                  <span class="n">showplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">sp</span><span class="o">=</span><span class="kc">None</span>
                  <span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Doing histogram cut for </span><span class="si">{</span><span class="n">d_col</span><span class="si">}</span><span class="s1">, slope_min:</span><span class="si">{</span><span class="n">slope_min</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> slope_max:</span><span class="si">{</span><span class="n">slope_max</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> slope_stepsize:</span><span class="si">{</span><span class="n">slope_stepsize</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nfwhm=</span><span class="si">{</span><span class="n">Nfwhm</span><span class="si">}</span><span class="s1">, rough_cut_px_min=</span><span class="si">{</span><span class="n">rough_cut_px_min</span><span class="si">}</span><span class="s1">, rough_cut_px_max=</span><span class="si">{</span><span class="n">rough_cut_px_max</span><span class="si">}</span><span class="s1">, Nsigma=</span><span class="si">{</span><span class="n">Nsigma</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># initialize plot</span>
    <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">=</span><span class="n">initplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">=</span><span class="kc">None</span>

    <span class="p">(</span><span class="n">rot_results</span><span class="p">,</span><span class="n">best_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">rotate_d_and_find_binmax</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span>
                                                        <span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                                                        <span class="n">Naxis_px</span><span class="p">,</span>
                                                        <span class="n">d_col_rot</span><span class="o">=</span><span class="n">d_col_rot</span><span class="p">,</span>
                                                        <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                                                        <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                                                        <span class="n">slope_min</span><span class="o">=</span><span class="n">slope_min</span><span class="p">,</span>
                                                        <span class="n">slope_max</span><span class="o">=</span><span class="n">slope_max</span><span class="p">,</span>
                                                        <span class="n">slope_stepsize</span><span class="o">=</span><span class="n">slope_stepsize</span><span class="p">,</span>
                                                        <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">,</span>
                                                        <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
                                                        <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
    
    <span class="c1"># Using the best dy_rotated, we first remove all entries with dy_rotated outside of dy_bestguess+-Nfwhm*fwhm</span>
    <span class="c1"># Note that FWHM ~ 2.355 stdev, so Nfwhm*fwhm should be at least 3*stdev. This is the first ROUGH cut, with </span>
    <span class="c1"># which we just want to remove excessive amounts of outliers. Then a 3-sigma cut is done on the *rotated* dy</span>
    <span class="n">rough_cut_px</span><span class="o">=</span> <span class="n">Nfwhm</span><span class="o">*</span><span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
    <span class="c1"># when using a rolling gaussian to smooth the histogram (in particular for small numbers of good matches), </span>
    <span class="c1"># the Nfwhm*fwhm method does nto work well. In that case it is better to use upper/lower limits</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting rough_cut_px=</span><span class="si">{</span><span class="n">rough_cut_px</span><span class="si">}</span><span class="s1">. limits: (</span><span class="si">{</span><span class="n">rough_cut_px_min</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">rough_cut_px_max</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rough_cut_px_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rough_cut_px</span><span class="o">&gt;</span><span class="n">rough_cut_px_max</span><span class="p">:</span>
        <span class="n">rough_cut_px</span><span class="o">=</span><span class="n">rough_cut_px_max</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rough_cut_px_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rough_cut_px</span><span class="o">&lt;</span><span class="n">rough_cut_px_min</span><span class="p">:</span>
        <span class="n">rough_cut_px</span><span class="o">=</span><span class="n">rough_cut_px_min</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting rough_cut_px=</span><span class="si">{</span><span class="n">rough_cut_px</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="p">(</span><span class="n">ixs_cut</span><span class="p">,</span><span class="n">ixs_roughcut</span><span class="p">)</span> <span class="o">=</span> <span class="n">sigmacut_d_rot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col</span><span class="p">,</span><span class="n">col</span><span class="p">,</span>
                                            <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span>
                                            <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;intercept&#39;</span><span class="p">],</span>
                                            <span class="n">rot_results</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_index</span><span class="p">,</span><span class="s1">&#39;d_bestguess&#39;</span><span class="p">],</span>
                                            <span class="n">rough_cut_px</span> <span class="o">=</span><span class="n">rough_cut_px</span> <span class="p">,</span>
                                            <span class="n">binsize</span><span class="o">=</span><span class="n">binsize</span><span class="p">,</span>
                                            <span class="n">Nsigma</span><span class="o">=</span><span class="n">Nsigma</span><span class="p">,</span>
                                            <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                                            <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">,</span>
                                            <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
                                            <span class="n">spi</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                                            <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
    <span class="k">return</span><span class="p">(</span><span class="n">ixs_cut</span><span class="p">,</span><span class="n">rot_results</span><span class="p">)</span>



<div class="viewcode-block" id="st_wcs_align"><a class="viewcode-back" href="../../api.html#jhat.st_wcs_align.st_wcs_align">[docs]</a><span class="k">class</span> <span class="nc">st_wcs_align</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for alignment.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    outrootdir : str</span>
<span class="sd">        output root directory. The output directoy is the output root directory + the outsubdir if not None</span>
<span class="sd">    outsubdir : str</span>
<span class="sd">            outsubdir added to output root directory</span>
<span class="sd">    overwrite : bool</span>
<span class="sd">            overwrite files if they exist.</span>
<span class="sd">    telescope : str</span>
<span class="sd">            If None, then telescope is determined automatically from the filename (&quot;jw*&quot; and &quot;hst*&quot; for JWST and HST, respectively)</span>
<span class="sd">    skip_if_exists : bool</span>
<span class="sd">            Skip doing the analysis of a given input image if the cal file already exists, assuming the full analysis has been already done</span>
<span class="sd">    verbose : int </span>
<span class="sd">            verbosity count (lower is less verbose)</span>
<span class="sd">    SNR_min : float </span>
<span class="sd">            mininum SNR for objects in image to be used for analysis</span>
<span class="sd">    use_dq : bool</span>
<span class="sd">            use the DQ extensions for masking</span>
<span class="sd">    refcat : str</span>
<span class="sd">            reference catalog. Can be a filename or Gaia </span>
<span class="sd">    refcat_racol : str</span>
<span class="sd">            RA column of reference catalog. If None, then automatically determined </span>
<span class="sd">    refcat_deccol : str</span>
<span class="sd">            Dec column of reference catalog. If None, then automatically determined</span>
<span class="sd">    refcat_magcol : str</span>
<span class="sd">            mag column of reference catalog. If None and not one of the default refcats like gaia, then 3rd column is used</span>
<span class="sd">    refcat_magerrcol : str</span>
<span class="sd">            magerr column of reference catalog. If None, then not used </span>
<span class="sd">    refcat_colorcol : str:</span>
<span class="sd">            color column of reference catalog. If None, then not used</span>
<span class="sd">    refcat_pmflag : bool</span>
<span class="sd">            Apply the proper motion correction (only for catalogs it is applicable, e.g., gaia</span>
<span class="sd">    refcat_pmmedian : bool</span>
<span class="sd">            Apply the MEDIAN proper motion correction (only for catalogs it is applicable, e.g., gaia</span>
<span class="sd">    photfilename : str</span>
<span class="sd">            photometry output filename. if &quot;auto&quot;, the fits in the image filename is substituted with phot.txt </span>
<span class="sd">    load_photcat_if_exists : bool</span>
<span class="sd">            If the photometric catalog file already exists, skip recreating it.</span>
<span class="sd">    rematch_refcat : bool</span>
<span class="sd">            if --load_photcat_if_exists and the photcat already exists, load the photcat, but rematch with refcat</span>
<span class="sd">    d2d_max : float</span>
<span class="sd">            maximum distance between source in image and refcat object, in arcsec</span>
<span class="sd">    dmag_max : float</span>
<span class="sd">            maximum uncertainty of sources in image </span>
<span class="sd">    sharpness_lim : list of float</span>
<span class="sd">            sharpness limits of sources in image (iterable of length 2)</span>
<span class="sd">    roundness1_lim : list of float</span>
<span class="sd">            roundness1 limits of sources in image (iterable of length 2)</span>
<span class="sd">    delta_mag_lim : list of float</span>
<span class="sd">            limits on mag - refcat_mainfilter (iterable of length 2)</span>
<span class="sd">    objmag_lim : list of float</span>
<span class="sd">            limits on mag, the magnitude of the objects in the image (iterable of length 2)</span>
<span class="sd">    refmag_lim : list of float</span>
<span class="sd">            limits on refcat_mainfilter, the magnitude of the reference catalog (iterable of length 2)</span>
<span class="sd">    slope_min : float</span>
<span class="sd">            minimum slope for linear correction applied to dx/dy. This effectively accounts for rotation. slopes go from slopemin to -slopemin</span>
<span class="sd">    Nbright4match : int </span>
<span class="sd">            Use only Nbright brightest objects for matching to the ref cat </span>
<span class="sd">    Nbright : int</span>
<span class="sd">            Use only Nbright brightest objects in image that are matched to refcat for alignment </span>
<span class="sd">    histocut_order : str</span>
<span class="sd">            histocut_order defines whether the histogram cut is first done for dx or first for dy (choices are &#39;dxdy&#39; or &#39;dydx&#39;)</span>
<span class="sd">    xshift : float</span>
<span class="sd">            added to the x coordinate before calculating ra,dec (only impacts ra,dec, not x). This can be used to correct for large shifts before matching!</span>
<span class="sd">    yshift : float</span>
<span class="sd">            added to the y coordinate before calculating ra,dec (only impacts ra,dec, not y). This can be used to correct for large shifts before matching! </span>
<span class="sd">    showplots : int </span>
<span class="sd">            showplots=1: most important plots. showplots=2: all plots (debug/test/finetune)</span>
<span class="sd">    saveplots : int </span>
<span class="sd">            saveplots=1: most important plots. saveplots=2: all plots (debug/test/finetune)</span>
<span class="sd">    savephottable : bool</span>
<span class="sd">            Save the final photometry table</span>
<span class="sd">    replace_sip : bool</span>
<span class="sd">            Replace the tweaked fits image wcs with the SIP representation.</span>
<span class="sd">    sip_err : float</span>
<span class="sd">            max_pix_error for SIP transformation.</span>
<span class="sd">    sip_degree : int </span>
<span class="sd">            degree for SIP transformation.</span>
<span class="sd">    sip_points : int</span>
<span class="sd">            npoints for SIP transformation.</span>
<span class="sd">    ee_radius : int </span>
<span class="sd">            encircled energy percentage (multiples of 10) for photometry</span>
<span class="sd">    rough_cut_px_min : float</span>
<span class="sd">            first rough cut: best d_rotated+-rough_cut_pix. This is the lower limit for rough_cut</span>
<span class="sd">    rough_cut_px_max : float</span>
<span class="sd">            first rough cut: best d_rotated+-rough_cut_pix. This is the upper limit for rough_cut </span>
<span class="sd">    d_rotated_Nsigma : float</span>
<span class="sd">            Nsigma for sigma cut of d_rotated. If 0.0, then 3-sigma cut is skipped </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">=</span><span class="n">jwst_photclass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs4use</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_sip</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sip_err</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sip_degree</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sip_points</span> <span class="o">=</span> <span class="mi">128</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_min</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_max</span><span class="o">=</span><span class="mf">0.8</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d_rotated_Nsigma</span><span class="o">=</span><span class="mf">3.0</span>        

    <span class="k">def</span> <span class="nf">define_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conflict_handler</span><span class="o">=</span><span class="s1">&#39;resolve&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span><span class="n">conflict_handler</span><span class="o">=</span><span class="n">conflict_handler</span><span class="p">)</span>

        <span class="c1">#parser.add_argument(&#39;--rate_dir&#39;, default=ratedir, help=&#39;Directory in which the rate images are located, which will be used to test the distortions. (default=%(default)s)&#39;)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;cal_image&#39;</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;cal.fits filename or any other image that is at a similar reduction stage.&#39;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parser</span><span class="p">):</span>

        <span class="c1"># default directory for input images</span>
        <span class="c1">#if &#39;JWST_DISTORTION_IMAGEDIR&#39; in os.environ:</span>
        <span class="c1">#    ratedir = os.environ[&#39;JWST_DISTORTION_IMAGEDIR&#39;]</span>
        <span class="c1">#else:</span>
        <span class="c1">#    ratedir = None</span>

        <span class="c1"># default directory for output</span>
        <span class="k">if</span> <span class="s1">&#39;JWST_OUTROOTDIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">outrootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JWST_OUTROOTDIR&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outrootdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outrootdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">outrootdir</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output root directory. The output directoy is the output root directory + the outsubdir if not None (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outsubdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;outsubdir added to output root directory (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--overwrite&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;overwrite files if they exist.&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--telescope&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If None, then telescope is determined automatically from the filename (&quot;jw*&quot; and &quot;hst*&quot; for JWST and HST, respectively) (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--skip_if_exists&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip doing the analysis of a given input image if the cal file already exists, assuming the full analysis has been already done&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--SNR_min&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;mininum SNR for object in image to be used for analysis (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use_dq&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use the DQ extensions for masking&#39;</span><span class="p">)</span>


        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Gaia&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;reference catalog. Can be a filename or Gaia (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_racol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;RA column of reference catalog. If None, then automatically determined (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_deccol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dec column of reference catalog. If None, then automatically determined (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_magcol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;mag column of reference catalog. If None and not one of the default refcats like gaia, then 3rd column is used (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_magerrcol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;magerr column of reference catalog. If None, then not used  (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_colorcol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;color column of reference catalog. If None, then not used (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_pmflag&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply the proper motion correction (only for catalogs it is applicable, e.g., gaia&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refcat_pmmedian&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply the MEDIAN proper motion correction (only for catalogs it is applicable, e.g., gaia&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--photfilename&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;photometry output filename. if &quot;auto&quot;, the fits in the image filename is substituted with phot.txt (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="c1">#        parser.add_argument(&#39;--photfilename&#39;, default=&#39;auto&#39;, help=&#39;photometry output filename. if &quot;auto&quot;, the fits in the image filename is substituted with phot.txt (default=%(default)s)&#39;)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--load_photcat_if_exists&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If the photometric catalog file already exists, skip recreating it.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rematch_refcat&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if --load_photcat_if_exists and the photcat already exists, load the photcat, but rematch with refcat&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--d2d_max&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum distance between source in image and refcat object, in arcsec (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dmag_max&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum uncertainty of sources in image (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sharpness_lim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;sharpness limits of sources in image (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--roundness1_lim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">0.75</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;roundness1 limits of sources in image (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--delta_mag_lim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;limits on mag - refcat_mainfilter (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--objmag_lim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;limits on mag, the magnitude of the objects in the image (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--refmag_lim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;limits on refcat_mainfilter, the magnitude of the reference catalog (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slope_min&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mf">0.005</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;minimum slope for linear correction applied to dx/dy. This effectively accounts for rotation. slopes go from slopemin to -slopemin (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nbright4match&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use only Nbright brightest objects for matching to the ref cat (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nbright&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use only Nbright brightest objects in image that are matched to refcat for alignment (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--histocut_order&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;dxdy&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dxdy&#39;</span><span class="p">,</span><span class="s1">&#39;dydx&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;histocut_order defines whether the histogram cut is first done for dx or first for dy (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--xshift&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;added to the x coordinate before calculating ra,dec (only impacts ra,dec, not x). This can be used to correct for large shifts before matching! (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--yshift&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;added to the y coordinate before calculating ra,dec (only impacts ra,dec, not y). This can be used to correct for large shifts before matching! (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span><span class="s1">&#39;--showplots&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;showplots=1: most important plots. showplots=2: all plots (debug/test/finetune)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--saveplots&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;saveplots=1: most important plots. saveplots=2: all plots (debug/test/finetune)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span><span class="s1">&#39;--savephottable&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save the final photometry table&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--replace_sip&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Replace the tweaked fits image wcs with the SIP representation.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sip_err&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;max_pix_error for SIP transformation.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sip_degree&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;degree for SIP transformation.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sip_points&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;npoints for SIP transformation.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ee_radius&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;encircled energy percentage (multiples of 10) for photometry&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--is_hst&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set if your image is from hst not jwst&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rough_cut_px_min&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;first rough cut: best d_rotated+-rough_cut_pix. This is the lower limit for rough_cut (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rough_cut_px_max&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;first rough cut: best d_rotated+-rough_cut_pix. This is the upper limit for rough_cut (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--d_rotated_Nsigma&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Nsigma for sigma cut of d_rotated. If 0.0, then 3-sigma cut is skipped (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    
<div class="viewcode-block" id="st_wcs_align.set_telescope"><a class="viewcode-back" href="../../api.html#jhat.st_wcs_align.st_wcs_align.set_telescope">[docs]</a>    <span class="k">def</span> <span class="nf">set_telescope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">telescope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figuring out which telescope your data come from (HST or JWST).</span>
<span class="sd">        Note that if your filename is non-standard, then you MUST set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">telescope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;neither telescope not image name is specified, cannot determine telescope&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^jw&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imname</span><span class="p">)):</span>
                <span class="n">telescope</span> <span class="o">=</span> <span class="s1">&#39;JWST&#39;</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^hst&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imname</span><span class="p">)):</span>
                <span class="n">telescope</span> <span class="o">=</span> <span class="s1">&#39;JWST&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot parse image name </span><span class="si">{</span><span class="n">imname</span><span class="si">}</span><span class="s1"> to determine telescope! Please set the &quot;telescope&quot; argument&#39;</span><span class="p">)</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="k">if</span> <span class="n">telescope</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;jwst&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">=</span><span class="n">jwst_photclass</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">telescope</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hst&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">=</span><span class="n">hst_photclass</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown telescope </span><span class="si">{</span><span class="n">telescope</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs4use</span><span class="o">=</span><span class="kc">None</span>            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;telescope set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">set_outdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outrootdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outsubdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outrootdir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        
        <span class="k">if</span> <span class="n">outsubdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">+=</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">outsubdir</span><span class="si">}</span><span class="s1">&#39;</span>
        
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

    <span class="c1"># make some rough cuts on dmag, d2d, and Nbright</span>
    <span class="c1"># sets phot.ixs_use and phot.ixs_notuse</span>
    <span class="k">def</span> <span class="nf">initial_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d2d_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dmag_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># sharpness limits</span>
                    <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># roundness1 limits </span>
                    <span class="n">delta_mag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag - refcat_mainfilter!</span>
                    <span class="n">objmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                    <span class="n">refmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog                    </span>
                    <span class="n">Nbright</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ixs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">phot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phot</span>
            
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">getindices</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
        <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;########### !!!!!!!!!!  INITIAL CUT: starting with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> objects&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">d2d_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;d2d =</span><span class="si">{</span><span class="n">d2d_max</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">d2d_colname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span><span class="si">}</span><span class="s1">_d2d&#39;</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="n">d2d_colname</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">d2d_max</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dmag_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dmag_max =</span><span class="si">{</span><span class="n">dmag_max</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;dmag&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">dmag_max</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sharpness_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sharpness_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SHARPNESS =</span><span class="si">{</span><span class="n">sharpness_lim</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">,</span><span class="n">sharpness_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sharpness_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">roundness1_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">roundness1_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;roundness1=</span><span class="si">{</span><span class="n">roundness1_lim</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;roundness1&#39;</span><span class="p">,</span><span class="n">roundness1_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">roundness1_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">objmag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">objmag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;objmag_lim=</span><span class="si">{</span><span class="n">objmag_lim</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="n">objmag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">objmag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delta_mag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">delta_mag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;delta_mag_lim=</span><span class="si">{</span><span class="n">delta_mag_lim</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot do delta_mag cut since the refcat_mainfilter is not defined!&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">,</span><span class="n">delta_mag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">delta_mag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">refmag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">refmag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;refmag_lim=</span><span class="si">{</span><span class="n">refmag_lim</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot do refmag_lim cut since the refcat_mainfilter is not defined!&#39;</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">refmag_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">refmag_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Nbright</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nbright=</span><span class="si">{</span><span class="n">Nbright</span><span class="si">}</span><span class="s1"> CUT:&#39;</span><span class="p">)</span>
            <span class="n">ixs_sort</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">ix_sort_by_cols</span><span class="p">([</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_use</span><span class="p">)</span>
            <span class="n">ixs_use</span> <span class="o">=</span> <span class="n">ixs_sort</span><span class="p">[:</span><span class="n">Nbright</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1"> left&#39;</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# of matched objects that pass initial cuts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_use</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">ixs_notuse</span> <span class="o">=</span> <span class="n">AnotB</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span><span class="n">ixs_use</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span> <span class="o">=</span> <span class="n">ixs_use</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span> <span class="o">=</span> <span class="n">ixs_notuse</span>
        <span class="k">return</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">run_align2refcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imfilename</span><span class="p">,</span>
                         <span class="n">phot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">ixs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="c1">#                         refcat_short=None,</span>
                         <span class="n">refcat_racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">refcat_deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                         <span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                         <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                         <span class="n">skip_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">savephot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="p">):</span>
            
        <span class="k">if</span> <span class="n">phot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phot</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span>
            
<span class="c1">#        if (racol is None) or (deccol is None): </span>
<span class="c1">#            if refcat_short is None:</span>
<span class="c1">#                refcat_short = phot.refcat.short</span>
<span class="c1">#                if refcat_short is None:</span>
<span class="c1">#                    raise RuntimeError(&#39;need the refcat shortname to identify ra,dec columns!&#39;)</span>
<span class="c1">#            racol = f&#39;{refcat_short}_ra&#39;</span>
<span class="c1">#            deccol = f&#39;{refcat_short}_dec&#39;</span>
            
        <span class="k">if</span> <span class="n">refcat_racol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_racol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_racol</span>
        <span class="k">if</span> <span class="n">refcat_deccol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_deccol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_deccol</span>

        <span class="n">tweakreg</span> <span class="o">=</span> <span class="n">tweakreg_hack</span><span class="o">.</span><span class="n">TweakRegStep</span><span class="p">()</span>
        <span class="n">cal_image</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imfilename</span><span class="p">)</span>

        <span class="n">tweakregfilename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_[a-zA-Z0-9]+\.fits$&#39;</span><span class="p">,</span><span class="s1">&#39;_tweakregstep.fits&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imfilename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">tweakregfilename</span> <span class="o">==</span> <span class="n">imfilename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;could not determine tweakreg filename for </span><span class="si">{imfilename}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tweakregfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting output directory for tweakregstep.fits file to </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">makepath</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_if_exists</span><span class="p">:</span>
                    <span class="c1"># return False means that rate2cal did not run</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1"> already exists, skipping recreating it...&#39;</span><span class="p">)</span>
                    <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">tweakregfilename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1"> already exists! exiting. If you want to overwrite or skip rate2cal reduction, you can use &quot;overwrite&quot; or &quot;skip_if_exists&quot;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># make sure output filename is deleted</span>
                <span class="n">rmfile</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">)</span>


        <span class="c1"># It is important to set fitgeometry to rshift</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span> <span class="o">=</span> <span class="s1">&#39;rshift&#39;</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">align_to_gaia</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">save_gaia_catalog</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># minimum number of objects required for fit</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">save_catalogs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">minobj</span> <span class="o">=</span> <span class="mi">4</span>
        
        <span class="c1"># the following parameters should have not impact, since these steps in tweakreg are skipped</span>
        <span class="k">if</span> <span class="mi">1</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">snr_threshold</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">separation</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">searchrad</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">minobj</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">min_gaia</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tweakreg</span><span class="o">.</span><span class="n">brightest</span> <span class="o">=</span> <span class="mi">1000</span>        
        
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">already_matched</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># phot_cal.t.loc[ixs_cal_good] is the table with the good matches!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> matches are passed to tweakreg </span><span class="si">{</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span><span class="si">}</span><span class="s1"> fitting&#39;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span>  <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,[</span><span class="n">xcol</span><span class="p">,</span><span class="n">ycol</span><span class="p">,</span><span class="n">refcat_racol</span><span class="p">,</span><span class="n">refcat_deccol</span><span class="p">]])</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">refcat</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">ref_racol</span> <span class="o">=</span> <span class="n">refcat_racol</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">ref_deccol</span> <span class="o">=</span> <span class="n">refcat_deccol</span>
        
        <span class="c1">### Provide your own source catalog, to be used in place of the default daofinder stuff. If you actually have a list</span>
        <span class="c1">### of images, it&#39;s okay to provide a source catalog for each. </span>
        <span class="n">cal_image</span><span class="o">.</span><span class="n">source_catalog</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">cal_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">cal_image</span><span class="p">]</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">source_xcol</span> <span class="o">=</span> <span class="n">xcol</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">source_ycol</span> <span class="o">=</span> <span class="n">ycol</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fitting tweakreg fitgeometry=</span><span class="si">{</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span><span class="si">}</span><span class="s1"> to xy=</span><span class="si">{</span><span class="n">xcol</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">ycol</span><span class="si">}</span><span class="s1"> to ra,dec=</span><span class="si">{</span><span class="n">refcat_racol</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">refcat_deccol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">cal_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_image</span><span class="p">)]</span>
        <span class="n">tweakreg</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cal_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1"> did not get created!!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_sip</span><span class="p">:</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">)</span>
            <span class="n">gwcs_header</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_fits_sip</span><span class="p">(</span><span class="n">max_pix_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip_err</span><span class="p">,</span>
                                                   <span class="n">max_inv_pix_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip_err</span><span class="p">,</span>
                                                   <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip_degree</span><span class="p">,</span>
                                                   <span class="n">npoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip_points</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
            <span class="n">dm_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gwcs_header</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dm_fits</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="n">key</span><span class="p">:</span>
                        <span class="n">dm_fits</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">break</span>
                <span class="c1">#astropy.wcs.WCS(header=gwcs_header)</span>
            <span class="n">dm_fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#print(imcat.meta[&#39;image_model&#39;].wcs)</span>
        <span class="c1">#print(gwcs_header)</span>
        <span class="c1">#imcat.meta[&#39;image_model&#39;].wcs = astropy.wcs.WCS(header=gwcs_header)</span>
        <span class="c1">#make sure the image got created</span>
        

        <span class="c1"># return True means that tweakrun did run</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">tweakregfilename</span><span class="p">)</span>
    

    <span class="k">def</span> <span class="nf">find_good_refcat_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">phot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">refcat_xcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">refcat_ycol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                 <span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                                 <span class="n">d2d_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">dmag_max</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># sharpness limits</span>
                                 <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># roundness1 limits </span>
                                 <span class="n">delta_mag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag-refcat_mainfilter</span>
                                 <span class="n">objmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                                 <span class="n">refmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog                    </span>
                                 <span class="n">Nbright</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">ixs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">showplots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">saveplots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">savephottable</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">outbasename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">plots_dxdy_delta_pix_ylim</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                 <span class="c1"># histogram cut parameters</span>
                                 <span class="n">histocut_order</span> <span class="o">=</span> <span class="s1">&#39;dxdy&#39;</span><span class="p">,</span> <span class="c1"># this can only be &#39;dxdy&#39; or &#39;dydx&#39;</span>
                                 <span class="n">binsize_px</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="c1"># this is the binsize of the dx/dy histograms</span>
                                 <span class="n">bin_weights_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1"># If bin_weights_flag is set to True, </span>
                                                       <span class="c1">#then the dx/dy bins are weighted by </span>
                                                       <span class="c1"># the flux of the detection.</span>
                                 <span class="n">slope_min</span><span class="o">=-</span><span class="mi">10</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> 
                                 <span class="n">slope_Nsteps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="c1"># slope_max=-slope_min, slope_stepsize=(slope_max-slope_min)/slope_Nsteps</span>
                                 <span class="n">Nfwhm</span> <span class="o">=</span> <span class="mf">2.5</span> 
                                 <span class="p">):</span>
        <span class="k">if</span> <span class="n">phot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phot</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">saveplots</span> <span class="ow">or</span> <span class="n">savephottable</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">outbasename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Trying to save plots and/or phot tables, but outbasename is None!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">refcat_xcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_xcol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_xcol</span>
        <span class="k">if</span> <span class="n">refcat_ycol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_ycol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_ycol</span>

        <span class="n">Nx</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
        <span class="n">Ny</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>
        
        <span class="c1"># Calculate dx and dy</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_xcol</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">xcol</span><span class="p">]</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_ycol</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">ycol</span><span class="p">]</span>

        <span class="c1"># Calculate the difference between JWST mag and main filter of reference catalog</span>
        <span class="k">if</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;delta_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># do some first very rough cuts.</span>
        <span class="c1"># sets phot.ixs_use and phot.ixs_notuse</span>
        <span class="c1"># returns phot.ixs_use</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cut</span><span class="p">(</span><span class="n">phot</span><span class="o">=</span><span class="n">phot</span><span class="p">,</span>
                               <span class="n">d2d_max</span><span class="o">=</span><span class="n">d2d_max</span><span class="p">,</span>
                               <span class="n">dmag_max</span><span class="o">=</span><span class="n">dmag_max</span><span class="p">,</span>
                               <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="n">sharpness_lim</span><span class="p">,</span> <span class="c1"># sharpness limits</span>
                               <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="n">roundness1_lim</span><span class="p">,</span> <span class="c1"># roundness1 limits </span>
                               <span class="n">delta_mag_lim</span> <span class="o">=</span> <span class="n">delta_mag_lim</span><span class="p">,</span> <span class="c1"># limits on mag-refcat_mainfilter</span>
                               <span class="n">objmag_lim</span> <span class="o">=</span> <span class="n">objmag_lim</span><span class="p">,</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                               <span class="n">refmag_lim</span> <span class="o">=</span> <span class="n">refmag_lim</span><span class="p">,</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog</span>
                               <span class="n">Nbright</span><span class="o">=</span><span class="n">Nbright</span><span class="p">,</span>
                               <span class="n">ixs</span><span class="o">=</span><span class="n">ixs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> objects pass the initial cut, at least 3 required!&#39;</span><span class="p">)</span>
        
        <span class="c1"># do the initial dx,dy plot and other important plots</span>
        <span class="c1"># it shows the initial cut.</span>
        <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">initial_dxdy_plot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_use</span><span class="p">,</span> <span class="n">phot</span><span class="o">.</span><span class="n">ixs_notuse</span><span class="p">,</span>
                              <span class="n">plots_dxdy_delta_pix_ylim</span><span class="o">=</span><span class="n">plots_dxdy_delta_pix_ylim</span><span class="p">,</span>
                              <span class="n">refcat_mainfilter</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span><span class="n">refcat_mainfilter_err</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter_err</span><span class="p">,</span><span class="n">refcat_maincolor</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">,</span>
                              <span class="n">d2d_max</span><span class="o">=</span><span class="n">d2d_max</span><span class="p">,</span><span class="n">dmag_max</span><span class="o">=</span><span class="n">dmag_max</span><span class="p">,</span><span class="n">Nbright</span><span class="o">=</span><span class="n">Nbright</span><span class="p">,</span><span class="n">delta_mag_lim</span><span class="o">=</span><span class="n">delta_mag_lim</span><span class="p">)</span>

        

        <span class="c1"># Here we correct for rotation so that we can robustly remove outlier matches</span>
        
        <span class="c1"># A straight line with a given slope is subtracted from dx versus y, which is </span>
        <span class="c1"># effectively a correction for a rotation.</span>
        
        <span class="c1"># Then a histogram of the resulting dx_rotated is calculated with bin size = binsize_px in pixels.</span>
        <span class="c1"># The maximum value of the histogram, it&#39;s associated dx_rot position, a rough upper limit estimate</span>
        <span class="c1"># of the fwhm of the histogram peak are then saved for each slope and intercept in dx_rot_results (pdastro table).</span>
        
        <span class="c1"># best_index is the index for this table for which the largest maxval of the histograms, presumably for </span>
        <span class="c1"># the best rotation (or slope)</span>
        
        <span class="c1"># slope loops from slope_min to slope_max=-slope_min with slope_stepsize</span>
        <span class="c1"># slope_min=-10.0/2048.0 means that slopes with a range </span>
        <span class="c1"># of +-10 pixels of 2048 pixels are probed, i.e. dx does not change</span>
        <span class="c1"># by more than 10 pixels over the full detector width</span>
        <span class="c1">#  slope_stepsize=(slope_max-slope_min)/slope_Nsteps</span>
 
        <span class="n">slope_max</span><span class="o">=-</span><span class="n">slope_min</span>
        <span class="n">slope_stepsize</span><span class="o">=</span><span class="p">(</span><span class="n">slope_max</span><span class="o">-</span><span class="n">slope_min</span><span class="p">)</span><span class="o">/</span><span class="n">slope_Nsteps</span>
       
        <span class="c1"># histocut_order defines whether the histogram cut is first done for dx or first for dy</span>
        <span class="k">if</span> <span class="n">histocut_order</span> <span class="o">==</span> <span class="s1">&#39;dxdy&#39;</span><span class="p">:</span>
            <span class="n">d_col1</span><span class="p">,</span><span class="n">col1</span><span class="p">,</span><span class="n">Naxis1_px</span> <span class="o">=</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">Ny</span>
            <span class="n">d_col2</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">Naxis2_px</span> <span class="o">=</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">Nx</span>
        <span class="k">elif</span> <span class="n">histocut_order</span> <span class="o">==</span> <span class="s1">&#39;dydx&#39;</span><span class="p">:</span>
            <span class="n">d_col1</span><span class="p">,</span><span class="n">col1</span><span class="p">,</span><span class="n">Naxis1_px</span> <span class="o">=</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">Nx</span>
            <span class="n">d_col2</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">Naxis2_px</span> <span class="o">=</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">Ny</span>


        <span class="c1"># Do the histogram cut on the first dcol (dx or dy, as selected)</span>
        <span class="p">(</span><span class="n">ixs_cut1</span><span class="p">,</span><span class="n">rot_results1</span><span class="p">)</span> <span class="o">=</span> <span class="n">histogram_cut</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs</span><span class="p">,</span><span class="n">d_col1</span><span class="p">,</span><span class="n">col1</span><span class="p">,</span><span class="n">Naxis1_px</span><span class="p">,</span>
                                                <span class="n">binsize</span><span class="o">=</span><span class="n">binsize_px</span><span class="p">,</span>
                                                <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                                                <span class="n">slope_min</span><span class="o">=</span><span class="n">slope_min</span><span class="p">,</span>
                                                <span class="n">slope_max</span><span class="o">=</span><span class="n">slope_max</span><span class="p">,</span>
                                                <span class="n">slope_stepsize</span><span class="o">=</span><span class="n">slope_stepsize</span><span class="p">,</span>
                                                <span class="n">Nfwhm</span><span class="o">=</span><span class="n">Nfwhm</span><span class="p">,</span>
                                                <span class="n">rough_cut_px_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_min</span><span class="p">,</span>
                                                <span class="n">rough_cut_px_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_max</span><span class="p">,</span>
                                                <span class="n">Nsigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_rotated_Nsigma</span><span class="p">,</span>
                                                <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">)</span>

        <span class="c1"># Do the histogram cut on the second dcol (dx or dy, as selected)</span>
        <span class="p">(</span><span class="n">ixs_cut2</span><span class="p">,</span><span class="n">rot_results2</span><span class="p">)</span> <span class="o">=</span> <span class="n">histogram_cut</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span><span class="n">ixs_cut1</span><span class="p">,</span><span class="n">d_col2</span><span class="p">,</span><span class="n">col2</span><span class="p">,</span><span class="n">Naxis2_px</span><span class="p">,</span>
                                                <span class="n">binsize</span><span class="o">=</span><span class="n">binsize_px</span><span class="p">,</span>
                                                <span class="n">bin_weights_flag</span><span class="o">=</span><span class="n">bin_weights_flag</span><span class="p">,</span>
                                                <span class="n">slope_min</span><span class="o">=</span><span class="n">slope_min</span><span class="p">,</span>
                                                <span class="n">slope_max</span><span class="o">=</span><span class="n">slope_max</span><span class="p">,</span>
                                                <span class="n">slope_stepsize</span><span class="o">=</span><span class="n">slope_stepsize</span><span class="p">,</span>
                                                <span class="n">Nfwhm</span><span class="o">=</span><span class="n">Nfwhm</span><span class="p">,</span>
                                                <span class="n">rough_cut_px_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_min</span><span class="p">,</span>
                                                <span class="n">rough_cut_px_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rough_cut_px_max</span><span class="p">,</span>
                                                <span class="n">Nsigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_rotated_Nsigma</span><span class="p">,</span>
                                                <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">savephottable</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.good.phot.txt&#39;</span><span class="p">)</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.good.phot.txt&#39;</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_cut2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">savephottable</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.all.phot.txt&#39;</span><span class="p">)</span>
                <span class="n">phot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.all.phot.txt&#39;</span><span class="p">)</span>

        <span class="c1">#if showplots&gt;1:</span>
            <span class="c1"># get the bad data points</span>
        <span class="c1">#    infoplots(phot,ixs_dy_cut,dy_plotlim=dy_plotlim,dx_plotlim=dx_plotlim)</span>
            

        <span class="k">return</span><span class="p">(</span><span class="n">ixs_cut2</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">update_phottable_final_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tweakregfilename</span><span class="p">,</span>
                                   <span class="n">ixs_bestmatch</span><span class="p">,</span>
                                   <span class="n">phot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">refcat_racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">refcat_deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">refcat_xcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">refcat_ycol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                                   
                                   <span class="n">showplots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">saveplots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">savephottable</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">outbasename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\.fits$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">tweakregfilename</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">outbasename</span> <span class="o">==</span> <span class="n">tweakregfilename</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not remove .fits from </span><span class="si">{</span><span class="n">tweakregfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">phot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phot</span>

        <span class="k">if</span> <span class="n">refcat_racol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_racol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_racol</span>
        <span class="k">if</span> <span class="n">refcat_deccol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_deccol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_deccol</span>
        <span class="k">if</span> <span class="n">refcat_xcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_xcol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_xcol</span>
        <span class="k">if</span> <span class="n">refcat_ycol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcat_ycol</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">refcat_ycol</span>


        <span class="c1"># show or save dxdy pre WCS correction</span>
        <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">saveplots</span><span class="p">:</span>
            <span class="n">dxdy_plot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span> <span class="n">ixs_bestmatch</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;pre WCS correction&#39;</span><span class="p">,</span>
                      <span class="n">refcat_mainfilter</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span>
                      <span class="n">refcat_mainfilter_err</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter_err</span><span class="p">,</span>
                      <span class="n">refcat_maincolor</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span>
                     <span class="p">)</span>
            <span class="k">if</span> <span class="n">saveplots</span><span class="p">:</span>
                <span class="n">outfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.phot.prewcs.png&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">):</span>
                    <span class="n">rmfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>


        <span class="c1">#racol=f&#39;{phot.refcat.short}_ra&#39;</span>
        <span class="c1">#deccol=f&#39;{phot.refcat.short}_dec&#39;</span>
        <span class="c1">#xcol=f&#39;{phot.refcat.short}_x&#39;</span>
        <span class="c1">#ycol=f&#39;{phot.refcat.short}_y&#39;</span>

        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="n">refcat_xcol</span><span class="p">,</span><span class="n">refcat_ycol</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_d2d&#39;</span> <span class="ow">in</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phot</span><span class="o">.</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_d2d&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
            
        
        <span class="n">image_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">ImageModel</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">)</span>
        <span class="c1"># recalculate the x,y of the ref cat objects</span>
        <span class="n">world_to_detector</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_xcol</span><span class="p">],</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_ycol</span><span class="p">]</span> <span class="o">=</span> <span class="n">world_to_detector</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_racol</span><span class="p">],</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_deccol</span><span class="p">])</span>
        
        <span class="c1"># recalculate dx, dy</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_xcol</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">refcat_ycol</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="c1"># recalculate the RA, Dec of the image objects</span>
        <span class="n">detector_to_world</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
        <span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detector_to_world</span><span class="p">(</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">phot</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">savephottable</span><span class="p">:</span>
            <span class="n">outfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.good.phot.txt&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1"> already exists! exiting. If you want to overwrite or skip rate2cal reduction, you can use &quot;overwrite&quot; or &quot;skip_if_exists&quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># make sure output filename is deleted</span>
                    <span class="n">rmfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">phot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_bestmatch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">savephottable</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">outfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.all.phot.txt&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1"> already exists! exiting. If you want to overwrite or skip rate2cal reduction, you can use &quot;overwrite&quot; or &quot;skip_if_exists&quot;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># make sure output filename is deleted</span>
                        <span class="n">rmfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">phot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>

        <span class="c1"># show or save dxdy post WCS correction</span>
        <span class="k">if</span> <span class="n">showplots</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">saveplots</span><span class="p">:</span>
            <span class="n">dxdy_plot</span><span class="p">(</span><span class="n">phot</span><span class="p">,</span> <span class="n">ixs_bestmatch</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;after WCS correction&#39;</span><span class="p">,</span>
                      <span class="n">refcat_mainfilter</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter</span><span class="p">,</span>
                      <span class="n">refcat_mainfilter_err</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_mainfilter_err</span><span class="p">,</span>
                      <span class="n">refcat_maincolor</span><span class="o">=</span><span class="n">phot</span><span class="o">.</span><span class="n">refcat_maincolor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">saveplots</span><span class="p">:</span>
                <span class="n">outfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outbasename</span><span class="si">}</span><span class="s1">.phot.finalwcs.png&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">):</span>
                    <span class="n">rmfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_image</span><span class="p">,</span>
                <span class="n">telescope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="c1">#distortion_file=None,</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">skip_if_exists</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="c1">#skip_applydistortions_if_exists = False,</span>
                <span class="n">use_dq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1"># refcat parameters</span>
                <span class="n">refcatname</span> <span class="o">=</span> <span class="s1">&#39;Gaia&#39;</span><span class="p">,</span>
                <span class="n">refcat_racol</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="n">refcat_deccol</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="n">refcat_magcol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">refcat_magerrcol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">refcat_colorcol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">pmflag</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">pm_median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">photfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">load_photcat_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">rematch_refcat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">SNR_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># minimum S/N for photometry</span>
                <span class="c1"># find best matches to refcut</span>
                <span class="n">d2d_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># maximum distance refcat to source in image</span>
                <span class="n">dmag_max</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># maximum uncertainty of source </span>
                <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># sharpness limits</span>
                <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># roundness1 limits </span>
                <span class="n">delta_mag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag-refcat_mainfilter</span>
                <span class="n">objmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                <span class="n">refmag_lim</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog                    </span>
                <span class="n">Nbright4match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># Use only the the brightest  Nbright sources from image for the matching with the ref catalog</span>
                <span class="n">Nbright</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># Use only the brightest Nbright sources from image after all other cuts</span>
                <span class="n">histocut_order</span><span class="o">=</span><span class="s1">&#39;dxdy&#39;</span><span class="p">,</span> <span class="c1"># histocut_order defines whether the histogram cut is first done for dx or first for dy</span>
                <span class="n">slope_min</span><span class="o">=-</span><span class="mi">10</span><span class="o">/</span><span class="mf">2048.0</span><span class="p">,</span> 
                <span class="n">slope_Nsteps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="c1"># slope_max=-slope_min, slope_stepsize=(slope_max-slope_min)/slope_Nsteps</span>
                <span class="n">Nfwhm</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
                <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="c1"># added to the x coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                <span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># added to the y coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                <span class="n">showplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">saveplots</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">savephottable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">ee_radius</span><span class="o">=</span><span class="mi">70</span>
                <span class="p">):</span>
            
        
        <span class="c1"># apply distortion coefficients if wanted.</span>
        <span class="c1">#if distortion_file is not None:</span>
            <span class="c1"># apply distortion terms</span>
        <span class="c1">#    (runflag,calimname) = self.run_applydistortions(input_image,</span>
        <span class="c1">#                                                    distortion_file,</span>
        <span class="c1">#                                                    overwrite = overwrite, </span>
        <span class="c1">#                                                    skip_if_exists = (skip_applydistortions_if_exists |  skip_if_exists))</span>
        <span class="c1">#else:</span>
        
        <span class="n">calimname</span> <span class="o">=</span> <span class="n">input_image</span>
            
        <span class="c1"># set the telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_telescope</span><span class="p">(</span><span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span><span class="n">imname</span><span class="o">=</span><span class="n">calimname</span><span class="p">)</span>
            
        <span class="c1"># do the photometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot</span><span class="o">.</span><span class="n">run_phot</span><span class="p">(</span><span class="n">calimname</span><span class="p">,</span>
                              <span class="n">use_dq</span><span class="o">=</span><span class="n">use_dq</span><span class="p">,</span>
                              <span class="n">refcatname</span><span class="o">=</span><span class="n">refcatname</span><span class="p">,</span>
                              <span class="n">refcat_racol</span><span class="o">=</span><span class="n">refcat_racol</span><span class="p">,</span>
                              <span class="n">refcat_deccol</span><span class="o">=</span><span class="n">refcat_deccol</span><span class="p">,</span>
                              <span class="n">refcat_magcol</span><span class="o">=</span><span class="n">refcat_magcol</span><span class="p">,</span>
                              <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="n">refcat_magerrcol</span><span class="p">,</span>
                              <span class="n">refcat_colorcol</span><span class="o">=</span><span class="n">refcat_colorcol</span><span class="p">,</span>
                              <span class="n">pmflag</span><span class="o">=</span><span class="n">pmflag</span><span class="p">,</span>
                              <span class="n">pm_median</span><span class="o">=</span><span class="n">pm_median</span><span class="p">,</span>
                              <span class="n">outrootdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                              <span class="n">photfilename</span><span class="o">=</span><span class="n">photfilename</span><span class="p">,</span>
                              <span class="n">load_photcat_if_exists</span><span class="o">=</span><span class="n">load_photcat_if_exists</span><span class="p">,</span>
                              <span class="n">rematch_refcat</span><span class="o">=</span><span class="n">rematch_refcat</span><span class="p">,</span>
                              <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                              <span class="n">Nbright4match</span><span class="o">=</span><span class="n">Nbright4match</span><span class="p">,</span>
                              <span class="n">SNR_min</span><span class="o">=</span><span class="n">SNR_min</span><span class="p">,</span>
                              <span class="n">xshift</span><span class="o">=</span><span class="n">xshift</span><span class="p">,</span>
                              <span class="n">yshift</span><span class="o">=</span><span class="n">yshift</span><span class="p">,</span>
                              <span class="n">ee_radius</span><span class="o">=</span><span class="n">ee_radius</span><span class="p">)</span>

        <span class="n">matching_outbasename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\.fits$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">calimname</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">matching_outbasename</span> <span class="o">==</span> <span class="n">calimname</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not remove .fits from </span><span class="si">{</span><span class="n">calimname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>        
        <span class="c1"># make sure the output files are in the self.outdir if set...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matching_outbasename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">matching_outbasename</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">ixs_bestmatch</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_good_refcat_matches</span><span class="p">(</span><span class="n">d2d_max</span> <span class="o">=</span> <span class="n">d2d_max</span><span class="p">,</span>
                                                 <span class="n">dmag_max</span> <span class="o">=</span> <span class="n">dmag_max</span><span class="p">,</span>
                                                 <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="n">sharpness_lim</span><span class="p">,</span> <span class="c1"># sharpness limits</span>
                                                 <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="n">roundness1_lim</span><span class="p">,</span> <span class="c1"># roundness1 limits </span>
                                                 <span class="n">delta_mag_lim</span> <span class="o">=</span> <span class="n">delta_mag_lim</span><span class="p">,</span> <span class="c1"># limits on mag-refcat_mainfilter</span>
                                                 <span class="n">objmag_lim</span> <span class="o">=</span> <span class="n">objmag_lim</span><span class="p">,</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                                                 <span class="n">refmag_lim</span> <span class="o">=</span> <span class="n">refmag_lim</span><span class="p">,</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog</span>
                                                 <span class="n">Nbright</span> <span class="o">=</span> <span class="n">Nbright</span><span class="p">,</span>
                                                 <span class="n">histocut_order</span><span class="o">=</span><span class="n">histocut_order</span><span class="p">,</span>
                                                 <span class="n">slope_min</span><span class="o">=</span><span class="n">slope_min</span><span class="p">,</span> 
                                                 <span class="n">slope_Nsteps</span> <span class="o">=</span> <span class="n">slope_Nsteps</span><span class="p">,</span> <span class="c1"># slope_max=-slope_min, slope_stepsize=(slope_max-slope_min)/slope_Nsteps</span>
                                                 <span class="n">Nfwhm</span> <span class="o">=</span> <span class="n">Nfwhm</span><span class="p">,</span>
                                                 <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">,</span>
                                                 <span class="n">saveplots</span><span class="o">=</span><span class="n">saveplots</span><span class="p">,</span>
                                                 <span class="n">savephottable</span><span class="o">=</span><span class="n">savephottable</span><span class="p">,</span>
                                                 <span class="n">outbasename</span><span class="o">=</span><span class="n">matching_outbasename</span>
                                                 <span class="p">)</span>        

        <span class="p">(</span><span class="n">runflag</span><span class="p">,</span><span class="n">tweakregfilename</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_align2refcat</span><span class="p">(</span><span class="n">calimname</span><span class="p">,</span><span class="n">ixs</span><span class="o">=</span><span class="n">ixs_bestmatch</span><span class="p">,</span>
                                                           <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span><span class="n">skip_if_exists</span><span class="o">=</span><span class="n">skip_if_exists</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_phottable_final_wcs</span><span class="p">(</span><span class="n">tweakregfilename</span><span class="p">,</span>
                                        <span class="n">ixs_bestmatch</span> <span class="o">=</span> <span class="n">ixs_bestmatch</span><span class="p">,</span>
                                        <span class="n">showplots</span><span class="o">=</span><span class="n">showplots</span><span class="p">,</span>
                                        <span class="n">saveplots</span><span class="o">=</span><span class="n">saveplots</span><span class="p">,</span>
                                        <span class="n">savephottable</span><span class="o">=</span><span class="n">savephottable</span><span class="p">,</span>
                                        <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span>
                                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">showplots</span><span class="p">:</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">wcs_align</span> <span class="o">=</span> <span class="n">st_wcs_align</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">wcs_align</span><span class="o">.</span><span class="n">define_options</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">replace_sip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace_sip</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">sip_err</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sip_err</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">sip_degree</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sip_degree</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">sip_points</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sip_points</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">rough_cut_px_min</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rough_cut_px_min</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">rough_cut_px_max</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rough_cut_px_max</span>
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">d_rotated_Nsigma</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">d_rotated_Nsigma</span>
    
    
    <span class="c1">#wcs_align.calphot=jwst_photclass()</span>
    
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">set_outdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outrootdir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">)</span>
    
    <span class="n">wcs_align</span><span class="o">.</span><span class="n">run_all</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cal_image</span><span class="p">,</span>
                     <span class="n">telescope</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span>
                     <span class="c1">#distortion_file = args.distortion_file,</span>
                     <span class="n">overwrite</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                     <span class="c1">#skip_applydistortions_if_exists=args.skip_applydistortions_if_exists,</span>
                     <span class="n">use_dq</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_dq</span><span class="p">,</span>
                     <span class="n">refcatname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat</span><span class="p">,</span>
                     <span class="n">refcat_racol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_racol</span><span class="p">,</span>
                     <span class="n">refcat_deccol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_deccol</span><span class="p">,</span>
                     <span class="n">refcat_magcol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_magcol</span><span class="p">,</span>
                     <span class="n">refcat_magerrcol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_magerrcol</span><span class="p">,</span>
                     <span class="n">refcat_colorcol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_colorcol</span><span class="p">,</span>
                     <span class="n">pmflag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_pmflag</span><span class="p">,</span>
                     <span class="n">pm_median</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refcat_pmmedian</span><span class="p">,</span>
                     <span class="n">photfilename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">photfilename</span><span class="p">,</span>
                     <span class="n">load_photcat_if_exists</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">load_photcat_if_exists</span><span class="p">,</span>
                     <span class="n">rematch_refcat</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rematch_refcat</span><span class="p">,</span>
                     <span class="n">SNR_min</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">SNR_min</span><span class="p">,</span>
                     <span class="n">d2d_max</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">d2d_max</span><span class="p">,</span> <span class="c1"># maximum distance refcat to source in image</span>
                     <span class="n">dmag_max</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dmag_max</span><span class="p">,</span> <span class="c1"># maximum uncertainty of source </span>
                     <span class="n">sharpness_lim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sharpness_lim</span><span class="p">,</span> <span class="c1"># sharpness limits</span>
                     <span class="n">roundness1_lim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">roundness1_lim</span><span class="p">,</span> <span class="c1"># roundness1 limits </span>
                     <span class="n">delta_mag_lim</span> <span class="o">=</span>  <span class="n">args</span><span class="o">.</span><span class="n">delta_mag_lim</span><span class="p">,</span> <span class="c1"># limits on mag-refcat_mainfilter</span>
                     <span class="n">objmag_lim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">objmag_lim</span><span class="p">,</span> <span class="c1"># limits on mag, the magnitude of the objects in the image</span>
                     <span class="n">refmag_lim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">refmag_lim</span><span class="p">,</span> <span class="c1"># limits on refcat_mainfilter, the magnitude of the reference catalog</span>
                     <span class="n">slope_min</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">slope_min</span><span class="p">,</span>
                     <span class="n">Nbright4match</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">Nbright4match</span><span class="p">,</span> <span class="c1"># Use only the the brightest  Nbright sources from image for the matching with the ref catalog</span>
                     <span class="n">Nbright</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">Nbright</span><span class="p">,</span>    <span class="c1"># U/se only the brightest Nbright sources from image</span>
                     <span class="n">histocut_order</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">histocut_order</span><span class="p">,</span> <span class="c1"># histocut_order defines whether the histogram cut is first done for dx or first for dy</span>
                     <span class="n">xshift</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xshift</span><span class="p">,</span><span class="c1"># added to the x coordinate before calculating ra,dec (only impacts ra,dec, not x). This can be used to correct for large shifts before matching!</span>
                     <span class="n">yshift</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">yshift</span><span class="p">,</span> <span class="c1"># added to the y coordinate before calculating ra,dec (only impacts ra,dec, not y). This can be used to correct for large shifts before matching!</span>
                     <span class="n">showplots</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">showplots</span><span class="p">,</span>
                     <span class="n">saveplots</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">saveplots</span><span class="p">,</span><span class="c1"># </span>
                     <span class="n">savephottable</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">savephottable</span><span class="p">,</span>
                     <span class="n">ee_radius</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ee_radius</span>
                     <span class="p">)</span>
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 Armin Rest &amp; Justin Pierel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>