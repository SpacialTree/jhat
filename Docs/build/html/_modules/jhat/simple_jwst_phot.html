<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jhat.simple_jwst_phot &mdash; jhat 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/jhat.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/jhat.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Primary Contributors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">jhat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jhat.simple_jwst_phot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jhat.simple_jwst_phot</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Wed Apr 27 09:21:15 2022</span>

<span class="sd">@author: arest, jpierel, mcorrenti</span>

<span class="sd">This is class wrapper around doing simple photometry on a single JWST image</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span><span class="nn">glob</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">copy</span><span class="o">,</span><span class="nn">math</span>

<span class="kn">import</span> <span class="nn">glob</span> <span class="k">as</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span><span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>


<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span><span class="p">,</span> <span class="n">Background2D</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span>

<span class="kn">import</span> <span class="nn">jwst</span>
<span class="kn">from</span> <span class="nn">jwst.datamodels</span> <span class="kn">import</span> <span class="n">ImageModel</span>
<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">datamodels</span>
<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">source_catalog</span>
<span class="kn">from</span> <span class="nn">jwst.source_catalog</span> <span class="kn">import</span> <span class="n">reference_data</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">pysiaf</span>
<span class="kn">from</span> <span class="nn">astroquery.gaia</span> <span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Catalogs</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">jwcf</span> <span class="kn">import</span> <span class="n">hawki</span><span class="p">,</span> <span class="n">hst</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>

<span class="kn">from</span> <span class="nn">.pdastro</span> <span class="kn">import</span> <span class="n">pdastroclass</span><span class="p">,</span><span class="n">pdastrostatsclass</span><span class="p">,</span><span class="n">makepath4file</span><span class="p">,</span><span class="n">unique</span><span class="p">,</span><span class="n">AnotB</span><span class="p">,</span><span class="n">AorB</span><span class="p">,</span><span class="n">AandB</span><span class="p">,</span><span class="n">rmfile</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jwst_photclass&#39;</span><span class="p">,</span><span class="s1">&#39;hst_photclass&#39;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">hst_get_ee_corr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="n">filt</span><span class="p">,</span><span class="n">inst</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">inst</span><span class="o">==</span><span class="s1">&#39;ir&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;ir_ee_corrections.csv&#39;</span><span class="p">):</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s1">&#39;https://www.stsci.edu/files/live/sites/www/files/home/hst/&#39;</span><span class="o">+</span>\
                                       <span class="s1">&#39;instrumentation/wfc3/data-analysis/photometric-calibration/&#39;</span><span class="o">+</span>\
                                       <span class="s1">&#39;ir-encircled-energy/_documents/ir_ee_corrections.csv&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;ir_ee_corrections.csv&#39;</span><span class="p">)</span>
        
        <span class="n">ee</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;ir_ee_corrections.csv&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;wfc3uvis2_aper_007_syn.csv&#39;</span><span class="p">):</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s1">&#39;https://www.stsci.edu/files/live/sites/www/files/home/hst/&#39;</span><span class="o">+</span>\
                                   <span class="s1">&#39;instrumentation/wfc3/data-analysis/photometric-calibration/&#39;</span><span class="o">+</span>\
                                   <span class="s1">&#39;uvis-encircled-energy/_documents/wfc3uvis2_aper_007_syn.csv&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;wfc3uvis2_aper_007_syn.csv&#39;</span><span class="p">)</span>
        <span class="n">ee</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;wfc3uvis2_aper_007_syn.csv&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">filts</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s1">&#39;FILTER&#39;</span><span class="p">)</span>
    <span class="n">waves</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">)</span>
    <span class="n">ee_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ee</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ee</span><span class="o">.</span><span class="n">colnames</span><span class="p">])</span>
    <span class="n">apps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ee</span><span class="o">.</span><span class="n">colnames</span><span class="p">]</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">waves</span><span class="p">,</span><span class="n">apps</span><span class="p">,</span><span class="n">ee_arr</span><span class="p">)</span>
    <span class="n">filt_wave</span> <span class="o">=</span> <span class="n">waves</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">filts</span><span class="o">==</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">filt_wave</span><span class="p">,</span><span class="n">ap</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">hst_get_zp</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">zpsys</span><span class="o">=</span><span class="s1">&#39;ab&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">zpsys</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;ab&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;F098M&#39;</span><span class="p">:</span><span class="mf">25.666</span><span class="p">,</span><span class="s1">&#39;F105W&#39;</span><span class="p">:</span><span class="mf">26.264</span><span class="p">,</span><span class="s1">&#39;F110W&#39;</span><span class="p">:</span><span class="mf">26.819</span><span class="p">,</span><span class="s1">&#39;F125W&#39;</span><span class="p">:</span><span class="mf">26.232</span><span class="p">,</span><span class="s1">&#39;F140W&#39;</span><span class="p">:</span><span class="mf">26.450</span><span class="p">,</span><span class="s1">&#39;F160W&#39;</span><span class="p">:</span><span class="mf">25.936</span><span class="p">}[</span><span class="n">filt</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">zpsys</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;vega&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;F098M&#39;</span><span class="p">:</span><span class="mf">25.090</span><span class="p">,</span><span class="s1">&#39;F105W&#39;</span><span class="p">:</span><span class="mf">25.603</span><span class="p">,</span><span class="s1">&#39;F110W&#39;</span><span class="p">:</span><span class="mf">26.042</span><span class="p">,</span><span class="s1">&#39;F125W&#39;</span><span class="p">:</span><span class="mf">25.312</span><span class="p">,</span><span class="s1">&#39;F140W&#39;</span><span class="p">:</span><span class="mf">25.353</span><span class="p">,</span><span class="s1">&#39;F160W&#39;</span><span class="p">:</span><span class="mf">24.662</span><span class="p">}[</span><span class="n">filt</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unknown zpsys&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">get_apcorr_params</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">ee</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">source_catalog</span><span class="o">.</span><span class="n">source_catalog_step</span><span class="o">.</span><span class="n">SourceCatalogStep</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">reffile_paths</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_get_reffile_paths</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">aperture_ee</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="n">ee</span><span class="p">)</span>

        <span class="n">refdata</span> <span class="o">=</span> <span class="n">reference_data</span><span class="o">.</span><span class="n">ReferenceData</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reffile_paths</span><span class="p">,</span>
                                <span class="n">aperture_ee</span><span class="p">)</span>
        <span class="n">aperture_params</span> <span class="o">=</span> <span class="n">refdata</span><span class="o">.</span><span class="n">aperture_params</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">aperture_params</span><span class="p">[</span><span class="s1">&#39;aperture_radii&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
           <span class="n">aperture_params</span><span class="p">[</span><span class="s1">&#39;aperture_corrections&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
           <span class="n">aperture_params</span><span class="p">[</span><span class="s1">&#39;bkg_aperture_inner_radius&#39;</span><span class="p">],</span>
           <span class="n">aperture_params</span><span class="p">[</span><span class="s1">&#39;bkg_aperture_outer_radius&#39;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">get_GAIA_sources_NP</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">pm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;Nor Pirzkal: Return a GAIA catalog/table that is location and time matched to an observation.</span>
<span class="sd">    It applies the GAIA proper motion by default (pm=True).</span>
<span class="sd">    The (x,y) pixel coordinates of the GAIA source are also returned in  &#39;x&#39; and &#39;y&#39; column.</span>
<span class="sd">    radius_factor is 2 by default and hence about twice that of the FOV but can be set.&quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">direct_with_wcs</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">world_to_pix</span> <span class="o">=</span> <span class="n">direct_with_wcs</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span><span class="s1">&#39;detector&#39;</span><span class="p">)</span>
    <span class="n">pix_to_world</span> <span class="o">=</span> <span class="n">direct_with_wcs</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>

    <span class="n">sy</span><span class="p">,</span><span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span> <span class="o">=</span> <span class="n">pix_to_world</span><span class="p">(</span><span class="n">sx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">sy</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pix_to_world</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dec0</span><span class="p">)</span><span class="o">*</span><span class="n">radius_factor</span> <span class="c1"># Approx radius needed in deg</span>
        
    <span class="n">job5</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">launch_job_async</span><span class="p">(</span><span class="s2">&quot;SELECT * </span><span class="se">\</span>
<span class="s2">                    FROM gaiadr2.gaia_source WHERE CONTAINS(POINT(&#39;ICRS&#39;,</span><span class="se">\</span>
<span class="s2">                    gaiadr2.gaia_source.ra,gaiadr2.gaia_source.dec),</span><span class="se">\</span>
<span class="s2">                    CIRCLE(&#39;ICRS&#39;,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> ,</span><span class="si">{}</span><span class="s2">))=1;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius</span><span class="p">))</span>
    <span class="n">tb_gaia</span> <span class="o">=</span> <span class="n">job5</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time_gaia</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ref_epoch&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jyear&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;MJD-AVG&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>

        <span class="n">dRA</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_obs</span> <span class="o">-</span> <span class="n">time_gaia</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dDec</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_obs</span> <span class="o">-</span> <span class="n">time_gaia</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dRA</span>
        <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dDec</span>
    
    <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">world_to_pix</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span>
    
    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span> 
    <span class="k">return</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_refcat_file</span><span class="p">(</span><span class="n">refcatfilename</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">pdastroclass</span><span class="p">()</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">refcatfilename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">racol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">racol</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot find racol </span><span class="si">{</span><span class="n">racol</span><span class="si">}</span><span class="s1"> in columns </span><span class="si">{</span><span class="n">cat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deccol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">deccol</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot find deccol </span><span class="si">{</span><span class="n">deccol</span><span class="si">}</span><span class="s1"> in columns </span><span class="si">{</span><span class="n">cat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_hawki_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;J2mag&#39;</span><span class="p">,</span><span class="s1">&#39;K2mag&#39;</span><span class="p">,</span><span class="s1">&#39;J2_K2&#39;</span><span class="p">,</span><span class="s1">&#39;q_Jmag&#39;</span><span class="p">,</span><span class="s1">&#39;gdr2_source_id&#39;</span><span class="p">,</span><span class="s1">&#39;sep_arcmin&#39;</span><span class="p">]):</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">hawki</span><span class="o">.</span><span class="n">hawki_catalog</span><span class="p">()</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;ra_deg&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">)</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;dec_deg&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">)</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;j_2mass_extrapolated&#39;</span><span class="p">,</span> <span class="s1">&#39;j_magnitude&#39;</span><span class="p">)</span>
    <span class="c1">#print(cat.columns)</span>

    <span class="n">pos0</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra0</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="n">pos0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sep_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sep_arcmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span><span class="o">/</span><span class="mf">60.0</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;J2_K2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;J2mag&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;K2mag&#39;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    
    <span class="c1"># only keep the values within the radius</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">Ntot</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="p">(</span><span class="n">keep</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;sep_deg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">radius_deg</span><span class="o">*</span><span class="n">radius_factor</span><span class="p">))</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="n">Ntot</span><span class="si">}</span><span class="s1"> of hawkI sources: all positions within </span><span class="si">{</span><span class="n">radius_deg</span><span class="o">*</span><span class="n">radius_factor</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> deg of RA/Dec=(</span><span class="si">{</span><span class="n">ra0</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">dec0</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span>
     
    <span class="c1">#print(&#39;bbb0&#39;,columns)</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_astroquery_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                     <span class="n">catalog_name</span> <span class="o">=</span> <span class="s1">&#39;Panstarrs&#39;</span><span class="p">,</span>
                     <span class="n">calc_mag_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">rename_mag_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># renames from f&#39;phot_{filt}_mean_mag&#39; to f&#39;{filt}&#39;</span>
                     <span class="n">remove_null</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GETTING </span><span class="si">%s</span><span class="s1"> CATALOG&#39;</span><span class="o">%</span><span class="n">catalog_name</span><span class="p">)</span>
    <span class="n">radec</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ra0</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">dec0</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ra0</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">)</span>
    <span class="n">catalog_data</span> <span class="o">=</span> <span class="n">Catalogs</span><span class="o">.</span><span class="n">query_object</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="n">catalog_name</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius_deg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">catalog_data</span>


<span class="k">def</span> <span class="nf">get_hst_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;pmra&#39;</span><span class="p">,</span><span class="s1">&#39;epmra&#39;</span><span class="p">,</span><span class="s1">&#39;pmdec&#39;</span><span class="p">,</span><span class="s1">&#39;epmdec&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;h_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;j_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;k_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;j_k&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sep_arcmin&#39;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">mjd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
        <span class="n">decimal_year_of_observation</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">decimalyear</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;decimal year = </span><span class="si">{</span><span class="n">decimal_year_of_observation</span><span class="si">}</span><span class="s1"> for HST LMC cat proper motion correction!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decimal_year_of_observation</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">cat</span> <span class="o">=</span> <span class="n">hst</span><span class="o">.</span><span class="n">hst_catalog</span><span class="p">(</span><span class="n">decimal_year_of_observation</span><span class="o">=</span><span class="n">decimal_year_of_observation</span><span class="p">)</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;ra_deg&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">)</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;dec_deg&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">)</span>
    <span class="c1">#print(cat.columns)</span>

    <span class="n">pos0</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra0</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="n">pos0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
    <span class="c1">#print(sep.degree)</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sep_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;sep_arcmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span><span class="o">/</span><span class="mf">60.0</span>
    <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;j_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;j_mag_vega&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;k_mag_vega&#39;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    
    <span class="c1"># only keep the values within the radius</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">Ntot</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="p">(</span><span class="n">keep</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="s1">&#39;sep_deg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">radius_deg</span><span class="o">*</span><span class="n">radius_factor</span><span class="p">))</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="n">Ntot</span><span class="si">}</span><span class="s1"> of HST LMC cat sources: all positions within </span><span class="si">{</span><span class="n">radius_deg</span><span class="o">*</span><span class="n">radius_factor</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> deg of RA/Dec=(</span><span class="si">{</span><span class="n">ra0</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">dec0</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span>
     
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_GAIA_sources</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                     <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># if mjd!=None, then proper motion (pm) adjustement is done</span>
                     <span class="n">pm_median</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if pm_median, then the median proper motion is added instead of the individual ones</span>
                     <span class="n">datarelease</span><span class="o">=</span><span class="s1">&#39;dr2&#39;</span><span class="p">,</span>
                     <span class="n">calc_mag_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">rename_mag_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># renames from f&#39;phot_{filt}_mean_mag&#39; to f&#39;{filt}&#39;</span>
                     <span class="n">remove_null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span><span class="s1">&#39;ref_epoch&#39;</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error&#39;</span><span class="p">,</span><span class="s1">&#39;pmra&#39;</span><span class="p">,</span><span class="s1">&#39;pmra_error&#39;</span><span class="p">,</span><span class="s1">&#39;pmdec&#39;</span><span class="p">,</span><span class="s1">&#39;pmdec_error&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;g_err&#39;</span><span class="p">,</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;bp_err&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">,</span><span class="s1">&#39;rp_err&#39;</span><span class="p">,</span><span class="s1">&#39;bp_rp&#39;</span><span class="p">,</span><span class="s1">&#39;bp_g&#39;</span><span class="p">,</span><span class="s1">&#39;g_rp&#39;</span><span class="p">,</span><span class="s1">&#39;bp_rp_err&#39;</span><span class="p">,</span><span class="s1">&#39;bp_g_err&#39;</span><span class="p">,</span><span class="s1">&#39;g_rp_err&#39;</span><span class="p">]):</span>
<span class="c1">#                     columns=[&#39;source_id&#39;,&#39;ref_epoch&#39;,&#39;ra&#39;,&#39;ra_error&#39;,&#39;dec&#39;,&#39;dec_error&#39;,&#39;pmra&#39;,&#39;pmra_error&#39;,&#39;pmdec&#39;,&#39;pmdec_error&#39;,</span>
<span class="c1">#                              &#39;phot_g_mean_mag&#39;,&#39;phot_bp_mean_mag&#39;,&#39;phot_rp_mean_mag&#39;,&#39;bp_rp&#39;,&#39;bp_g&#39;,&#39;g_rp&#39;,&#39;phot_g_mean_flux&#39;,&#39;phot_g_mean_flux_error&#39;,&#39;phot_bp_mean_flux&#39;,&#39;phot_bp_mean_flux_error&#39;,&#39;phot_rp_mean_flux&#39;,&#39;phot_rp_mean_flux_error&#39;]):</span>
    <span class="k">if</span> <span class="n">datarelease</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="s1">&#39;gaiadr2&#39;</span>
    <span class="k">elif</span> <span class="n">datarelease</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dr2&#39;</span><span class="p">,</span><span class="s1">&#39;gaiadr2&#39;</span><span class="p">]:</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="s1">&#39;gaiadr2&#39;</span>
    <span class="k">elif</span> <span class="n">datarelease</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edr3&#39;</span><span class="p">,</span><span class="s1">&#39;gaiaedr3&#39;</span><span class="p">]:</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="s1">&#39;gaiaedr3&#39;</span>
    <span class="k">elif</span> <span class="n">datarelease</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dr3&#39;</span><span class="p">,</span><span class="s1">&#39;gaiadr3&#39;</span><span class="p">]:</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="s1">&#39;gaiadr3&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;datarelease </span><span class="si">{</span><span class="n">datarelease</span><span class="si">}</span><span class="s1"> not known yet&#39;</span><span class="p">)</span>
    
    <span class="n">query</span> <span class="o">=</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{}</span><span class="s2">.gaia_source WHERE CONTAINS(POINT(&#39;ICRS&#39;,</span><span class="se">\</span>
<span class="s2">            </span><span class="si">{}</span><span class="s2">.gaia_source.ra,</span><span class="si">{}</span><span class="s2">.gaia_source.dec),</span><span class="se">\</span>
<span class="s2">            CIRCLE(&#39;ICRS&#39;,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> ,</span><span class="si">{}</span><span class="s2">))=1;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">dr</span><span class="p">,</span><span class="n">dr</span><span class="p">,</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;query:</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">job5</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">launch_job_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">tb_gaia</span> <span class="o">=</span> <span class="n">job5</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">mjd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Applying proper motion correction to epoch mjd=</span><span class="si">{</span><span class="n">mjd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">time_gaia</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ref_epoch&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jyear&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>

        <span class="n">dRA</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_obs</span> <span class="o">-</span> <span class="n">time_gaia</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dDec</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_obs</span> <span class="o">-</span> <span class="n">time_gaia</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">pm_median</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dRA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dDec</span><span class="p">))</span> 
            <span class="n">dRA_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dRA</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>
            <span class="n">dDec_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dDec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;adding median pm dRA=</span><span class="si">{</span><span class="n">dRA_median</span><span class="si">}</span><span class="s1"> and dDec=</span><span class="si">{</span><span class="n">dDec_median</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dRA_median</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dDec_median</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ref_epoch1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">decimalyear</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dRA</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dDec</span>
            <span class="n">tb_gaia</span><span class="p">[</span><span class="s1">&#39;ref_epoch1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">decimalyear</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;ra1&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span> <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ra1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;dec1&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span> <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dec1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;ref_epoch1&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span> <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ref_epoch1&#39;</span><span class="p">)</span>
        <span class="c1">#tb_gaia[&#39;dRA&#39;] = dRA</span>
        <span class="c1">#tb_gaia[&#39;dDec&#39;] = dDec</span>
        <span class="c1">#columns.extend([&#39;dRA&#39;,&#39;dDec&#39;])</span>
        <span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra1&#39;</span>
        <span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### NO propoer motion correction!!!&#39;</span><span class="p">)</span>
        <span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span>
        <span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec&#39;</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">tb_gaia</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

    <span class="c1"># renames columns from f&#39;phot_{filt}_mean_mag&#39; to f&#39;{filt}&#39;</span>
    <span class="k">if</span> <span class="n">rename_mag_colnames</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;phot_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_mean_mag&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                              
    <span class="k">if</span> <span class="n">calc_mag_errors</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">]:</span>
            <span class="n">fluxcol</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;phot_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_mean_flux&#39;</span>
            <span class="n">dfluxcol</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fluxcol</span><span class="si">}</span><span class="s1">_error&#39;</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_err&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">2.5</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">dfluxcol</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">fluxcol</span><span class="p">]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">filt1</span><span class="p">,</span><span class="n">filt2</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">),(</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">)]:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filt2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filt2</span><span class="si">}</span><span class="s1">_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">remove_null</span><span class="p">:</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="p">[</span><span class="n">racol</span><span class="p">,</span><span class="n">deccol</span><span class="p">]:</span>
            <span class="c1">#print(&#39;XXX&#39;,indices)</span>
            <span class="p">(</span><span class="n">notnull</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">colname</span><span class="p">]))</span>
            <span class="n">ixs</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">notnull</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars after removing nan&#39;s:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">racol</span><span class="p">]))</span>
                 
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="c1">#print(df[&#39;source_id&#39;])</span>
    <span class="c1">#sys.exit(0)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">racol</span><span class="p">,</span><span class="n">deccol</span><span class="p">)</span>

    

<span class="k">def</span> <span class="nf">get_GAIA_sources_for_image</span><span class="p">(</span><span class="n">imagefilename</span><span class="p">,</span><span class="n">pm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a GAIA catalog/table that is location and time matched to an observation.</span>
<span class="sd">    It applies the GAIA proper motion by default (pm=True).</span>
<span class="sd">    The (x,y) pixel coordinates of the GAIA source are also returned in  &#39;x&#39; and &#39;y&#39; column.</span>
<span class="sd">    radius_factor is 1.1 by default and hence about 10% that of the FOV but can be set.</span>
<span class="sd">    original author: Nor Pirzkal, modified by Armin Rest</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imagefilename</span><span class="p">)</span>

    <span class="n">hdr</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>

    <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
 
    <span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">coord0</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">radius_deg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>        
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>     
            <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">radius_deg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">radius_deg</span><span class="p">)</span><span class="o">*</span><span class="n">radius_factor</span> 

    <span class="n">df</span><span class="p">,</span><span class="n">racol</span><span class="p">,</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">get_GAIA_sources</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;MJD-AVG&#39;</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">racol</span><span class="p">,</span><span class="n">deccol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_image_siaf_aperture</span><span class="p">(</span><span class="n">aperturename</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">):</span>

    <span class="n">instrument</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">]</span>
    <span class="n">apername</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;APERNAME&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GGGGGGGGGGGG&#39;</span><span class="p">,</span><span class="n">apername</span><span class="p">,</span><span class="n">aperturename</span><span class="p">)</span>
    
    <span class="n">ra_ref_orig</span> <span class="o">=</span> <span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;RA_REF&#39;</span><span class="p">]</span>
    <span class="n">dec_ref_orig</span> <span class="o">=</span> <span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;DEC_REF&#39;</span><span class="p">]</span>
    <span class="n">roll_ref_orig</span> <span class="o">=</span> <span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;ROLL_REF&#39;</span><span class="p">]</span>
    
    <span class="n">siaf</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">Siaf</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>

    <span class="n">aper_orig</span> <span class="o">=</span> <span class="n">siaf</span><span class="p">[</span><span class="n">apername</span><span class="p">]</span>

    <span class="n">v2_ref_orig</span> <span class="o">=</span> <span class="n">aper_orig</span><span class="o">.</span><span class="n">V2Ref</span>     
    <span class="n">v3_ref_orig</span> <span class="o">=</span> <span class="n">aper_orig</span><span class="o">.</span><span class="n">V3Ref</span>     

    <span class="n">attitude</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rotations</span><span class="o">.</span><span class="n">attitude</span><span class="p">(</span><span class="n">v2_ref_orig</span><span class="p">,</span> <span class="n">v3_ref_orig</span><span class="p">,</span> <span class="n">ra_ref_orig</span><span class="p">,</span> <span class="n">dec_ref_orig</span><span class="p">,</span> <span class="n">roll_ref_orig</span><span class="p">)</span>

    <span class="n">aper_orig</span><span class="o">.</span><span class="n">set_attitude_matrix</span><span class="p">(</span><span class="n">attitude</span><span class="p">)</span>

    <span class="n">image_siaf_aperture</span> <span class="o">=</span> <span class="n">siaf</span><span class="p">[</span><span class="n">aperturename</span><span class="p">]</span>
    <span class="n">image_siaf_aperture</span><span class="o">.</span><span class="n">set_attitude_matrix</span><span class="p">(</span><span class="n">attitude</span><span class="p">)</span>
      
    <span class="k">return</span> <span class="n">image_siaf_aperture</span>

<span class="k">def</span> <span class="nf">radec_to_idlX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">,</span><span class="n">aperturename</span><span class="o">=</span><span class="s1">&#39;APERNAME&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="o">=</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">):</span>
    <span class="c1"># Method from Mario</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
    <span class="n">siaf</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">Siaf</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>   <span class="c1">### this line will slow you down, better if you can pass the SIAF object directly (or read it from the main)</span>
    <span class="n">apername</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="n">aperturename</span><span class="p">]</span>
    <span class="n">ap</span><span class="o">=</span> <span class="n">siaf</span><span class="o">.</span><span class="n">apertures</span><span class="p">[</span><span class="n">apername</span><span class="p">]</span>
    <span class="n">xidl</span><span class="p">,</span><span class="n">yidl</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">sci_to_idl</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xidl</span><span class="p">,</span> <span class="n">yidl</span>


<span class="k">def</span> <span class="nf">radec_to_idl</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">aperturename</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">):</span>

    <span class="n">image_siaf_aperture</span> <span class="o">=</span> <span class="n">get_image_siaf_aperture</span><span class="p">(</span><span class="n">aperturename</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">)</span>

    <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>      <span class="o">=</span> <span class="n">image_siaf_aperture</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="s1">&#39;sky&#39;</span><span class="p">,</span> <span class="s1">&#39;idl&#39;</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def xy_to_idl(x, y, aperturename, primaryhdr, scihdr):</span>

<span class="sd">    image_siaf_aperture = get_image_siaf_aperture(aperturename, primaryhdr, scihdr)</span>

<span class="sd">    x_idl, y_idl      = image_siaf_aperture.det(x, y, &#39;det&#39;, &#39;idl&#39;)</span>
<span class="sd">  </span>
<span class="sd">    return x_idl, y_idl</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">xy_to_idl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">,</span><span class="n">aperturename</span><span class="o">=</span><span class="s1">&#39;APERNAME&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="o">=</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span><span class="n">pysiaf_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Method from Mario</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
    <span class="n">siaf</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">Siaf</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>   <span class="c1">### this line will slow you down, better if you can pass the SIAF object directly (or read it from the main)</span>
    <span class="k">if</span> <span class="n">pysiaf_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">apername</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="n">aperturename</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">apername</span> <span class="o">=</span> <span class="n">pysiaf_name</span>

    <span class="n">ap</span><span class="o">=</span> <span class="n">siaf</span><span class="o">.</span><span class="n">apertures</span><span class="p">[</span><span class="n">apername</span><span class="p">]</span>
    <span class="n">xidl</span><span class="p">,</span><span class="n">yidl</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">sci_to_idl</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xidl</span><span class="p">,</span> <span class="n">yidl</span>

<div class="viewcode-block" id="jwst_photclass"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.jwst_photclass">[docs]</a><span class="k">class</span> <span class="nc">jwst_photclass</span><span class="p">(</span><span class="n">pdastrostatsclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The photometry class for JWST images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for JWST photometry class</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jwst_photclass : :class:`~jhat.jwst_photclass`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pdastrostatsclass</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;NIRCAM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="s1">&#39;F090W&#39;</span><span class="p">,</span> <span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F140M&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W&#39;</span><span class="p">,</span> <span class="s1">&#39;F162M&#39;</span><span class="p">,</span> <span class="s1">&#39;F164N&#39;</span><span class="p">,</span> <span class="s1">&#39;F182M&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;F187N&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">,</span> <span class="s1">&#39;F210M&#39;</span><span class="p">,</span> <span class="s1">&#39;F212N&#39;</span><span class="p">,</span> <span class="s1">&#39;F250M&#39;</span><span class="p">,</span> <span class="s1">&#39;F277W&#39;</span><span class="p">,</span> <span class="s1">&#39;F300M&#39;</span><span class="p">,</span> <span class="s1">&#39;F322W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F323N&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;F335M&#39;</span><span class="p">,</span> <span class="s1">&#39;F356W&#39;</span><span class="p">,</span> <span class="s1">&#39;F360M&#39;</span><span class="p">,</span> <span class="s1">&#39;F405N&#39;</span><span class="p">,</span> <span class="s1">&#39;F410M&#39;</span><span class="p">,</span> <span class="s1">&#39;F430M&#39;</span><span class="p">,</span> <span class="s1">&#39;F444W&#39;</span><span class="p">,</span> <span class="s1">&#39;F460M&#39;</span><span class="p">,</span> <span class="s1">&#39;F466N&#39;</span><span class="p">,</span> <span class="s1">&#39;F470N&#39;</span><span class="p">,</span> <span class="s1">&#39;F480M&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;NIRISS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F090W&#39;</span><span class="p">,</span> <span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F140M&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W&#39;</span><span class="p">,</span> <span class="s1">&#39;F158M&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">,</span> <span class="s1">&#39;F277W&#39;</span><span class="p">,</span> <span class="s1">&#39;F356W&#39;</span><span class="p">,</span> <span class="s1">&#39;F380M&#39;</span><span class="p">,</span> <span class="s1">&#39;F430M&#39;</span><span class="p">,</span> <span class="s1">&#39;F444W&#39;</span><span class="p">,</span> <span class="s1">&#39;F480M&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;MIRI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F560W&#39;</span><span class="p">,</span><span class="s1">&#39;F770W&#39;</span><span class="p">,</span><span class="s1">&#39;F1000W&#39;</span><span class="p">,</span><span class="s1">&#39;F1130W&#39;</span><span class="p">,</span><span class="s1">&#39;F1280W&#39;</span><span class="p">,</span><span class="s1">&#39;F1500W&#39;</span><span class="p">,</span><span class="s1">&#39;F1800W&#39;</span><span class="p">,</span><span class="s1">&#39;F2100W&#39;</span><span class="p">,</span><span class="s1">&#39;F2550W&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;FGS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NA&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="s1">&#39;NIRCAM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.987</span><span class="p">,</span> <span class="mf">1.103</span><span class="p">,</span> <span class="mf">1.298</span><span class="p">,</span> <span class="mf">1.553</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">,</span> <span class="mf">1.770</span><span class="p">,</span> <span class="mf">1.801</span><span class="p">,</span> <span class="mf">1.494</span><span class="p">,</span> <span class="mf">1.990</span><span class="p">,</span> <span class="mf">2.060</span><span class="p">,</span> <span class="mf">2.141</span><span class="p">,</span> <span class="mf">2.304</span><span class="p">,</span> <span class="mf">2.341</span><span class="p">,</span> <span class="mf">1.340</span><span class="p">,</span>
                                   <span class="mf">1.444</span><span class="p">,</span> <span class="mf">1.585</span><span class="p">,</span> <span class="mf">1.547</span><span class="p">,</span> <span class="mf">1.711</span><span class="p">,</span> <span class="mf">1.760</span><span class="p">,</span> <span class="mf">1.830</span><span class="p">,</span> <span class="mf">1.901</span><span class="p">,</span> <span class="mf">2.165</span><span class="p">,</span> <span class="mf">2.179</span><span class="p">,</span> <span class="mf">2.300</span><span class="p">,</span> <span class="mf">2.302</span><span class="p">,</span> <span class="mf">2.459</span><span class="p">,</span> <span class="mf">2.507</span><span class="p">,</span> <span class="mf">2.535</span><span class="p">,</span> <span class="mf">2.574</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="s1">&#39;NIRISS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.40</span><span class="p">,</span> <span class="mf">1.40</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">,</span> <span class="mf">1.70</span><span class="p">,</span> <span class="mf">1.80</span><span class="p">,</span> <span class="mf">1.80</span><span class="p">,</span> <span class="mf">1.80</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="s1">&#39;MIRI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.22</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.32</span><span class="p">,</span><span class="mf">0.36</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.48</span><span class="p">,</span><span class="mf">0.58</span><span class="p">,</span><span class="mf">0.67</span><span class="p">,</span><span class="mf">0.82</span><span class="p">]</span> <span class="c1"># THESE ARE IN ARCSEC...TRANSLATED BELOW</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="s1">&#39;FGS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.50</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">instrument</span><span class="p">]))}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DNunits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_bkgsub</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="c1"># define the radii of the aperture in units of fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_for_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_Nfwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_sky_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_Nfwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_sky_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_sky_in</span> <span class="o">+</span> <span class="mf">2.0</span>
        
        <span class="c1"># These values will be set when the photometry is run! They are</span>
        <span class="c1"># set depending on filter and self.radi*_Nfwhm*</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_for_mag_px</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_short</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_racol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_deccol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_xcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_ycol</span> <span class="o">=</span> <span class="kc">None</span>

        
    

    <span class="k">def</span> <span class="nf">define_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conflict_handler</span><span class="o">=</span><span class="s1">&#39;resolve&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span><span class="n">conflict_handler</span><span class="o">=</span><span class="n">conflict_handler</span><span class="p">)</span>

        <span class="c1"># default directory for output</span>
        <span class="k">if</span> <span class="s1">&#39;JWST_OUTROOTDIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">outrootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JWST_OUTROOTDIR&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outrootdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span>  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input image file&#39;</span><span class="p">)</span>
        
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--photfilename&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output filename for photometry catalog. if &quot;auto&quot;, then the fits of the image filename is substituted with phot.txt. If outrootdir and/or outsubdir is not None, then they are used for the path. (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outrootdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">outrootdir</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output root directory. The output directoy for the photometry file is the output root directory + the outsubdir if not None (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outsubdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;outsubdir added to output root directory (default=</span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--overwrite&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;overwrite files if they exist.&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ee_radius&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;encircled energy percentage (multiples of 10) for photometry&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--is_hst&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set if your image is from hst not jwst&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">imagetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DNunits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_dq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">skip_preparing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">imagename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_plane_pixel_scales</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">*</span>\
         <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">subarray</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">aperture</span><span class="o">.</span><span class="n">name</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">filtername</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">subarray</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Instrument: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s1">, aperture:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">imagetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;cal\.fits$|tweakregstep\.fits$|assignwcsstep\.fits$&#39;</span><span class="p">,</span><span class="n">imagename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="s1">&#39;cal&#39;</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;i2d\.fits$&#39;</span><span class="p">,</span><span class="n">imagename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="s1">&#39;i2d&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown image type for file </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="n">imagetype</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_preparing</span><span class="p">:</span>
            <span class="c1"># prepare the data.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">==</span> <span class="s1">&#39;cal&#39;</span><span class="p">:</span>
                <span class="c1">#print(&#39;VVVVV&#39;,self.im.info())</span>
                <span class="c1">#sys.exit(0)</span>
                <span class="n">dq</span><span class="o">=</span><span class="kc">None</span>
                <span class="k">if</span> <span class="n">use_dq</span><span class="p">:</span> 
                    <span class="n">dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;DQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using DQ extension!!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;AREA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: AREA extension has different dimensions (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">) than SCI extension (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">)! Using image header info to fix this...&#39;</span><span class="p">)</span>
                    <span class="n">SUBSTRT1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;SUBSTRT1&#39;</span><span class="p">]</span>
                    <span class="n">SUBSTRT2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;SUBSTRT2&#39;</span><span class="p">]</span>
                    <span class="n">SUBSIZE1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;SUBSIZE1&#39;</span><span class="p">]</span>
                    <span class="n">SUBSIZE2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;SUBSIZE2&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;subarray area = AREA[</span><span class="si">{</span><span class="n">SUBSTRT2</span><span class="si">}</span><span class="s1">-1:</span><span class="si">{</span><span class="n">SUBSTRT2</span><span class="si">}</span><span class="s1">-1+</span><span class="si">{</span><span class="n">SUBSIZE2</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">SUBSTRT1</span><span class="si">}</span><span class="s1">-1:</span><span class="si">{</span><span class="n">SUBSTRT1</span><span class="si">}</span><span class="s1">-1+</span><span class="si">{</span><span class="n">SUBSIZE1</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;AREA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">SUBSTRT2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">SUBSTRT2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">SUBSIZE2</span><span class="p">,</span><span class="n">SUBSTRT1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">SUBSTRT1</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">SUBSIZE1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;AREA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">DNunits</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                                                                        <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">,</span>
                                                                        <span class="n">dq</span> <span class="o">=</span> <span class="n">dq</span><span class="p">,</span>
                                                                        <span class="n">DNunits</span><span class="o">=</span><span class="n">DNunits</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">==</span> <span class="s1">&#39;i2d&#39;</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">DNunits</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                                                                        <span class="n">DNunits</span><span class="o">=</span><span class="n">DNunits</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span><span class="si">}</span><span class="s1"> not yet implemented!&#39;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_original</span><span class="p">,</span> <span class="n">imhdr</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">DNunits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dq_ignore_bits</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># dq_ignore_bits contains the bits in the dq which are still ok, so they</span>
        <span class="c1"># should be ignored.</span>
        <span class="c1"># 2 = Pixel saturated during integration</span>
        <span class="c1"># 4 = Jump detected during integration</span>
        
        <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying Pixel Area Map&#39;</span><span class="p">)</span>
        
            <span class="n">data_pam</span> <span class="o">=</span> <span class="n">data_original</span> <span class="o">*</span> <span class="n">area</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">data_pam</span> <span class="o">=</span> <span class="n">data_original</span>
        
        <span class="k">if</span> <span class="n">DNunits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imhdr</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;MJy/sr&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;imhdr[&quot;BUNIT&quot;]=</span><span class="si">{</span><span class="n">imhdr</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> is not MJy/sr!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converting units from </span><span class="si">{</span><span class="n">imhdr</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to DN/s&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_pam</span> <span class="o">/</span> <span class="n">imhdr</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_pam</span>
        
        
        <span class="k">if</span> <span class="n">dq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># dq_ignore_bits are removed from the mask!</span>
            <span class="c1">#fits.writeto(&#39;TEST_dq_delme.fits&#39;,dq,overwrite=True,output_verify=&#39;ignore&#39;)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">~</span><span class="n">dq_ignore_bits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># hijack a few bits for our purposes...</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="c1">#fits.writeto(&#39;TEST_mask_delme.fits&#39;,mask,overwrite=True,output_verify=&#39;ignore&#39;)</span>
               
        <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">DNunits</span>
    
    <span class="k">def</span> <span class="nf">get_bool_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>  <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="n">boolmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boolmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
       
        <span class="n">boolmask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">boolmask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>         
        
        <span class="k">return</span><span class="p">(</span><span class="n">boolmask</span><span class="p">)</span>
        
            
    <span class="k">def</span> <span class="nf">calc_bkg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
        <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
        <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>
       
        
        <span class="k">if</span> <span class="n">var_bkg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using 2D Background&#39;</span><span class="p">)</span>
            <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
            
            <span class="n">boolmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bool_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    
            <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span>
                               <span class="n">coverage_mask</span><span class="o">=</span><span class="n">boolmask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    
            <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data_bkgsub</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>
    
            <span class="n">median</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_rms_median</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background median and rms using Background 2D:&#39;</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background and rms using MMMBackground and MADStdBackgroundRMS:&#39;</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">data_bkgsub</span><span class="p">,</span> <span class="n">std</span>
    
    <span class="k">def</span> <span class="nf">get_fwhm_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filt</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># in the future, this can be changed to get the values directly from CRDS</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Can</span><span class="se">\&#39;</span><span class="s1">t get FWHM, instrument is not known&#39;</span><span class="p">)</span>
            
        <span class="c1"># NIRISS is special: it has some filters in the pupil wheel</span>
        <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;NIRISS&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^F&#39;</span><span class="p">,</span><span class="n">filt</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^F&#39;</span><span class="p">,</span><span class="n">pupil</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;can</span><span class="se">\&#39;</span><span class="s1">t figure out the NIRISS filter: </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pupil</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filt</span><span class="o">=</span><span class="n">pupil</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># all good!</span>
                <span class="k">pass</span>

        <span class="n">fwhm_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MIRI&#39;</span><span class="p">:</span>
            <span class="n">fwhm_psf</span><span class="o">/=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span>
        <span class="k">return</span><span class="p">(</span><span class="n">fwhm_psf</span><span class="p">)</span>
        
        

<div class="viewcode-block" id="jwst_photclass.find_stars"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.jwst_photclass.find_stars">[docs]</a>    <span class="k">def</span> <span class="nf">find_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        threshold : float </span>
<span class="sd">            The absolute image value above which to select sources.</span>
<span class="sd">        </span>
<span class="sd">        fwhm : float</span>
<span class="sd">            The full-width half-maximum (FWHM) of the major axis of the Gaussian kernel in units of pixels.</span>
<span class="sd">            </span>
<span class="sd">        var_bkg : bool</span>
<span class="sd">            Use Background2D (see description above)</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>
        
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span>
        <span class="k">if</span> <span class="n">det</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GUIDER1&#39;</span><span class="p">,</span><span class="s1">&#39;GUIDER2&#39;</span><span class="p">]:</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
            <span class="n">pupil</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">filt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtername</span>
            <span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finding stars --- Detector: </span><span class="si">{d}</span><span class="s1">, Filter: </span><span class="si">{f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
        
        <span class="c1">#sigma_psf = self.dict_utils[filt][&#39;psf fwhm&#39;]</span>
        <span class="n">fwhm_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fwhm_psf</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">pupil</span><span class="p">)</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FWHM for the filter </span><span class="si">{f}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">fwhm_psf</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>

        <span class="n">zero_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nan_mask</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">full_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">nan_mask</span><span class="p">,</span><span class="n">zero_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
             <span class="n">full_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">full_mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">bool_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">data_bkgsub</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_bkg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">bool_mask</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="n">var_bkg</span><span class="p">)</span>

        <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm_psf</span><span class="p">,</span> <span class="n">exclude_border</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bkgsub</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">bool_mask</span><span class="p">)</span>
        <span class="c1">#found_stars = daofind(data_bkgsub)</span>
                    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of sources found in the image:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bkgsub</span></div>
    
    <span class="k">def</span> <span class="nf">get_radii_phot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">pupil</span><span class="p">,</span> 
                       <span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                       
                       <span class="n">radius_Nfwhm_sky_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                       <span class="n">radius_Nfwhm_sky_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">radius_Nfwhm_for_mag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">radii_Nfwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_Nfwhm</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">radii_Nfwhm</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">radii_Nfwhm</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="p">[</span><span class="n">radii_Nfwhm</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">radius_Nfwhm_for_mag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">radius_Nfwhm_for_mag</span> <span class="o">=</span> <span class="n">radii_Nfwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">radius_Nfwhm_sky_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
           <span class="n">radius_Nfwhm_sky_in</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_sky_in</span>
           
        <span class="k">if</span> <span class="n">radius_Nfwhm_sky_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
           <span class="n">radius_Nfwhm_sky_out</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_Nfwhm_sky_out</span>
           
          
        
        <span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fwhm_psf</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">pupil</span><span class="p">)</span>
        
        <span class="n">radii</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fwhm</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">radii_Nfwhm</span><span class="p">]</span>
        <span class="n">radius_for_mag</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">*</span><span class="n">radius_Nfwhm_for_mag</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">radius_for_mag</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;radius for mag </span><span class="si">{</span><span class="n">radius_for_mag</span><span class="si">}</span><span class="s1"> is not in </span><span class="si">{</span><span class="n">radii</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">radius_sky_in</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">*</span><span class="n">radius_Nfwhm_sky_in</span>
        <span class="n">radius_sky_out</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">*</span><span class="n">radius_Nfwhm_sky_out</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span><span class="n">radius_sky_in</span><span class="p">,</span><span class="n">radius_sky_out</span><span class="p">,</span><span class="n">radius_for_mag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">colname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">basecolname</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">basecolname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">px&#39;</span><span class="p">)</span>

    <span class="c1">#def aperture_phot(self, radius=[3.5], sky_in=7, sky_out=10, add_radius_to_colname=False):</span>
<div class="viewcode-block" id="jwst_photclass.aperture_phot"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.jwst_photclass.aperture_phot">[docs]</a>    <span class="k">def</span> <span class="nf">aperture_phot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pupil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">radius_Nfwhm_sky_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radius_Nfwhm_sky_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radius_Nfwhm_for_mag</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aperture photometry routine for HST.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        table_aper : :class:`astropy.table.Table`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span> <span class="o">=</span> <span class="n">get_apcorr_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ee_radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_for_mag_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span>

        <span class="c1"># det = primaryhdr[&#39;DETECTOR&#39;]</span>
        <span class="c1"># if filt is None:</span>
        <span class="c1">#     if det in [&#39;GUIDER1&#39;,&#39;GUIDER2&#39;]:</span>
        <span class="c1">#         filt = &#39;NA&#39;</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         filt = primaryhdr[&#39;FILTER&#39;]</span>
        <span class="c1"># if pupil is None: </span>
        <span class="c1">#     if det in [&#39;GUIDER1&#39;,&#39;GUIDER2&#39;]:</span>
        <span class="c1">#         pupil = &#39;NA&#39;</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         pupil = primaryhdr[&#39;PUPIL&#39;]</span>

        <span class="c1"># (self.radii_px,</span>
        <span class="c1">#  self.radius_sky_in_px,</span>
        <span class="c1">#  self.radius_sky_out_px,</span>
        <span class="c1">#  self.radius_for_mag_px) = self.get_radii_phot(filt,pupil,</span>
        <span class="c1">#                                                radii_Nfwhm = radii_Nfwhm,</span>
        <span class="c1">#                                                radius_Nfwhm_sky_in = radius_Nfwhm_sky_in, </span>
        <span class="c1">#                                                radius_Nfwhm_sky_out = radius_Nfwhm_sky_out, </span>
        <span class="c1">#                                                radius_Nfwhm_for_mag = radius_Nfwhm_for_mag)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;radii:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="si">}</span><span class="s1">pixels radius_sky_in:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="si">}</span><span class="s1"> radius_sky_out:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span><span class="si">}</span><span class="s1">  radius_for_mag:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_for_mag_px</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
        
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
        <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing aperture photometry for radius r = </span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s1"> px&#39;</span><span class="p">)</span>
            <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
            
            <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> 
                                               <span class="n">r_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="p">,</span> 
                                               <span class="n">r_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span><span class="p">)</span>
            <span class="n">annulus_masks</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
            <span class="n">local_sky_median</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">local_sky_stdev</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">annulus_mask</span> <span class="ow">in</span> <span class="n">annulus_masks</span><span class="p">:</span>
                
                <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">annulus_mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">annulus_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">annulus_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
                    <span class="n">mean_sigclip</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">,</span> 
                                                                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mean_sigclip</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">median_sigclip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">median_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.99</span>
                        <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.99</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">median_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.99</span>
                    <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.99</span>
                
                <span class="n">local_sky_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
                <span class="n">local_sky_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_sigclip</span><span class="p">)</span>
            
            <span class="n">local_sky_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_sky_median</span><span class="p">)</span>
            <span class="n">local_sky_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_sky_stdev</span><span class="p">)</span>
            
<span class="c1">#            if select_dq:        </span>
<span class="c1">#                </span>
<span class="c1">#                phot = aperture_photometry(data, aperture, method=&#39;exact&#39;)</span>
            
<span class="c1">#            else:</span>
                
<span class="c1">#                zero_mask = np.where(data == 0,0,1)</span>
<span class="c1">#                nan_mask  = np.where(np.isnan(data),0,1)</span>
<span class="c1">#                zero_mask = nan_mask * zero_mask</span>
<span class="c1">#        </span>
<span class="c1">#                nan_mask = np.where(zero_mask == 0,True,False)</span>
            <span class="n">boolmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bool_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            
            <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span><span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">boolmask</span><span class="p">)</span>
            
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_sky_median</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_sky_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_poisson</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])</span>
                <span class="n">error_scatter_sky</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">local_sky_stdev</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">error_mean_sky</span> <span class="o">=</span> <span class="n">local_sky_stdev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">area</span>
                <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_poisson</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">error_scatter_sky</span> <span class="o">+</span> <span class="n">error_mean_sky</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">]</span>
            
        
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span>
            <span class="n">fluxerr</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">fluxerr</span><span class="o">/</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]))</span>
            
            <span class="n">flux_units</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">flux_units</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_sum&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;flux_err&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dmag&#39;</span><span class="p">)</span>

            <span class="c1">#if rad == self.radius_for_mag_px:</span>
                <span class="c1">#table_aper[&#39;mag&#39;] = -2.5 * np.log10(table_aper[self.colname(&#39;aper_sum_bkgsub&#39;,rad)])</span>
                <span class="c1">#table_aper[&#39;dmag&#39;] = 1.086 * (table_aper[self.colname(&#39;flux_err&#39;,rad)] / </span>
                <span class="c1">#                              table_aper[self.colname(&#39;aper_sum_bkgsub&#39;,rad)])      </span>

        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;roundness1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness1&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span> <span class="o">=</span> <span class="n">table_aper</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">])]</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">table_aper</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">table_aper</span></div>

    <span class="k">def</span> <span class="nf">clean_phottable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SNR_min</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># remove nans</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix_not_null</span><span class="p">([</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="s1">&#39;dmag&#39;</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> objects left after removing entries with NaNs in mag or dmag column&#39;</span><span class="p">)</span>
        <span class="c1">#self.write()</span>
        
        <span class="k">if</span> <span class="n">SNR_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmag_max</span> <span class="o">=</span> <span class="mf">1.086</span> <span class="o">*</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">SNR_min</span>
            <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;dmag&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">dmag_max</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SNR_min cut: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="si">}</span><span class="s1"> objects left after removing entries dmag&gt;</span><span class="si">{</span><span class="n">dmag_max</span><span class="si">}</span><span class="s1"> (SNR&lt;</span><span class="si">{</span><span class="n">SNR_min</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xy_to_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>

        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        
        <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">xcol</span><span class="p">]</span><span class="o">+</span><span class="n">xshift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">ycol</span><span class="p">]</span><span class="o">+</span><span class="n">yshift</span><span class="p">)</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">racol</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">deccol</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span>

    <span class="k">def</span> <span class="nf">radec_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>

        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="n">world_to_detector</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">xcol</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">ycol</span><span class="p">])</span> <span class="o">=</span> <span class="n">world_to_detector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">racol</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">deccol</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">radec_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">xcol_idl</span><span class="o">=</span><span class="s1">&#39;x_idl&#39;</span><span class="p">,</span> <span class="n">ycol_idl</span><span class="o">=</span><span class="s1">&#39;y_idl&#39;</span><span class="p">,</span>
                     <span class="n">aperturename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>

        <span class="k">if</span> <span class="n">aperturename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aperturename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span>

    
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">()</span>
    
        <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>      <span class="o">=</span> <span class="n">radec_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">racol</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">deccol</span><span class="p">],</span>
                                         <span class="n">aperturename</span><span class="p">,</span> 
                                         <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">x_idl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">ycol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">y_idl</span>
  
        <span class="k">return</span> <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>
        
    <span class="k">def</span> <span class="nf">xy_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">xcol_idl</span><span class="o">=</span><span class="s1">&#39;x_idl&#39;</span><span class="p">,</span> <span class="n">ycol_idl</span><span class="o">=</span><span class="s1">&#39;y_idl&#39;</span><span class="p">,</span>
                     <span class="n">aperturename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>
    
        <span class="k">if</span> <span class="n">aperturename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aperturename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol</span><span class="p">])</span>
        <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>      <span class="o">=</span> <span class="n">xy_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol</span><span class="p">],</span> 
                                      <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">ycol</span><span class="p">],</span>
                                      <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">x_idl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">ycol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">y_idl</span>
  
        <span class="k">return</span> <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>
    

    <span class="k">def</span> <span class="nf">init_refcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refcatname</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">refcat_racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_magcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_colorcol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span> <span class="o">=</span> <span class="n">pdastroclass</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">refcatname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;gaia&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mjd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="s1">&#39;ra1&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="s1">&#39;dec1&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="s1">&#39;ra&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="s1">&#39;dec&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;gaia&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;g_err&#39;</span><span class="p">,</span><span class="s1">&#39;rp&#39;</span><span class="p">,</span><span class="s1">&#39;rp_err&#39;</span><span class="p">,</span><span class="s1">&#39;g_rp&#39;</span><span class="p">,</span><span class="s1">&#39;g_rp_err&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="s1">&#39;g_err&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="s1">&#39;g_rp&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;LMC_gaia_DR3.nrcposs&#39;</span><span class="p">:</span>
            <span class="c1">#self.refcat.load_spacesep(refcatname)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="s1">&#39;ra&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="s1">&#39;dec&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;gaia&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaia_mag&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="s1">&#39;gaia_mag&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;hst_lmc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="s1">&#39;ra&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="s1">&#39;dec&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;hst&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;h_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;j_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;k_mag_vega&#39;</span><span class="p">,</span><span class="s1">&#39;j_k&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="s1">&#39;j&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="s1">&#39;j_k&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;hawki&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="s1">&#39;ra&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="s1">&#39;dec&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;hawki&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;ra_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;dec_error_mas&#39;</span><span class="p">,</span><span class="s1">&#39;J2mag&#39;</span><span class="p">,</span><span class="s1">&#39;K2mag&#39;</span><span class="p">,</span><span class="s1">&#39;J2_K2&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="s1">&#39;J2mag&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="s1">&#39;J2_K2&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="n">refcat_racol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">refcat_deccol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">refcatname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="n">refcatname</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;reffile&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[]</span><span class="c1">#[&#39;ID&#39;,&#39;ra_error_mas&#39;,&#39;dec_error_mas&#39;,&#39;J2mag&#39;,&#39;K2mag&#39;,&#39;J2_K2&#39;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="n">refcat_magcol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="n">refcat_magerrcol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="n">refcat_colorcol</span>
                
        <span class="k">if</span> <span class="n">refcat_racol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="o">=</span> <span class="n">refcat_racol</span>
        <span class="k">if</span> <span class="n">refcat_deccol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">refcat_deccol</span>
        <span class="k">if</span> <span class="n">refcat_magcol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="o">=</span> <span class="n">refcat_magcol</span>
        <span class="k">if</span> <span class="n">refcat_magerrcol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="o">=</span> <span class="n">refcat_magerrcol</span>
        <span class="k">if</span> <span class="n">refcat_colorcol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="o">=</span> <span class="n">refcat_colorcol</span>
                
        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_refcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refcatname</span><span class="p">,</span>
                    <span class="n">ra0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dec0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">radius_deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">pm_median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">refcat_racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_magcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refcat_colorcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pmflag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># initialize the refcat, and set racol,deccol and other</span>
        <span class="c1"># parameters depending on the choice of refcat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_refcat</span><span class="p">(</span><span class="n">refcatname</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                         <span class="n">refcat_racol</span><span class="o">=</span><span class="n">refcat_racol</span><span class="p">,</span><span class="n">refcat_deccol</span><span class="o">=</span><span class="n">refcat_deccol</span><span class="p">,</span><span class="n">refcat_magcol</span><span class="o">=</span><span class="n">refcat_magcol</span><span class="p">,</span>
                         <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="n">refcat_magerrcol</span><span class="p">,</span><span class="n">refcat_colorcol</span><span class="o">=</span><span class="n">refcat_colorcol</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA/Dec columns in reference catalog: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">refcatname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;gaia&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">get_GAIA_sources</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span><span class="n">pm_median</span><span class="o">=</span><span class="n">pm_median</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">getindices</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;LMC_gaia_DR3.nrcposs&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">load_spacesep</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">getindices</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;hst_lmc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">get_hst_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">refcatname</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;hawki&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mjd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pm_median</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot correct for proper motion with catalog </span><span class="si">{refcatname}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="o">=</span> <span class="n">get_hawki_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">refcatname</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;LOADING refcat </span><span class="si">{</span><span class="n">refcatname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">get_refcat_file</span><span class="p">(</span><span class="n">refcatname</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="n">deccol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>\
                 <span class="p">(</span><span class="s1">&#39;dec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;When supplying a catalog, either use ra/dec colnames or set refcat_racol and refcat_deccol.&#39;</span><span class="p">)</span>
<span class="c1">#                if self.refcat.mainfilter is None or self.refcat.mainfilter_err is None or self.refcat.maincolor is None:</span>
<span class="c1">#                    raise RuntimeError(&quot;When using a custom catalog, must supply refcat_magcol, refcat_magcolerr,&quot;+\</span>
<span class="c1">#                        &quot; and refcat_colorcol as coloumname1_columnname_2&quot;)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;When using a custom catalog, must supply refcat_magcol&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">get_astroquery_cat</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span><span class="n">catalog_name</span><span class="o">=</span><span class="n">refcatname</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t know what to do with reference catalog </span><span class="si">{</span><span class="n">refcatname</span><span class="si">}</span><span class="s1">! Not a known refcat, and not a file!&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>\
                                    <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;When using an astroquery catalog, must supply refcat_racol,&quot;</span><span class="o">+</span>\
                        <span class="s2">&quot; refcat_deccol, refcat_magcol, refcat_magcolerr, and  refcat_colorcol as coloumname1_columnname_2 (&quot;</span><span class="o">+</span>\
                            <span class="s2">&quot;Column names are: &quot;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="c1">#self.refcat.getindices()</span>

            <span class="c1"># make sure color is defined if maincolor is not None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="n">f1</span><span class="p">,</span><span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">colnames</span> <span class="ow">or</span> <span class="n">f2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Must supply refcat_colorcol in form magcol1_magcol2.&#39;</span><span class="p">)</span>
    
                    <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">f2</span><span class="p">]</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                        
        
        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">getrefcatcolname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colname</span><span class="p">,</span><span class="n">refcatshort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">requiredflag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">existsflag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refcatshort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refcatshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcatshort</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
           <span class="n">colname</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s1">&#39;</span>
           <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">requiredflag</span> <span class="ow">or</span> <span class="n">existsflag</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Column </span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s1"> is required, but is not one of the Table columns </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requiredflag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This column is required and cannot be set to None!&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">set_important_refcatcols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refcatshort</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refcatshort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refcatshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span>
            
        <span class="k">if</span> <span class="n">refcatshort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The short name of the reference catalog is not None, cannot define the important reference catalog columns in the matched photometric catalog!&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refcatshort</span> <span class="o">=</span> <span class="n">refcatshort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_racol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">requiredflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_deccol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">requiredflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_xcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">requiredflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_ycol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">requiredflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_mainfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span><span class="p">,</span><span class="n">existsflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_mainfilter_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span><span class="p">,</span><span class="n">existsflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat_maincolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrefcatcolname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span><span class="p">,</span><span class="n">existsflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
<div class="viewcode-block" id="jwst_photclass.match_refcat"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.jwst_photclass.match_refcat">[docs]</a>    <span class="k">def</span> <span class="nf">match_refcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">max_sep</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">borderpadding</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                     <span class="n">refcatshort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches the photometry catalog to the reference catalog.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_sep : float</span>
<span class="sd">            Maximum separation between sources in arcseconds</span>
<span class="sd">        borderpadding : float</span>
<span class="sd">            Pixel separation required from border of image</span>
<span class="sd">        refcatshort : string, optional</span>
<span class="sd">            Short name of reference catalog that is used as prefix for the column names. The default is None.</span>
<span class="sd">            If None, then refcatshort is set to self.refcat.short</span>
<span class="sd">        indices : list</span>
<span class="sd">            The indices to access the photometry catalog, default None (use the full catalog)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matching reference catalog </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">refcatshort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcatshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span>

        <span class="c1">#if primaryhdr is None: primaryhdr=self.primaryhdr</span>
        <span class="c1">#if scihdr is None: scihdr=self.scihdr</span>
        
        <span class="c1"># if aperturename is None:</span>
        <span class="c1">#     aperturename = self.aperture</span>

        <span class="c1"># make sure there are no NaNs        </span>
        <span class="n">ixs_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix_not_null</span><span class="p">([</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="c1"># get SkyCoord objects (needed for matching)</span>
        <span class="n">objcoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

        
        <span class="c1"># find the x_idl and y_idl range, so that we can cut down the objects from the outside catalog!!</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;x_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;x_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;y_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;y_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image objects are in x_idl=[</span><span class="si">{</span><span class="n">xmin</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">xmax</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">] and y_idl=[</span><span class="si">{</span><span class="n">ymin</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">ymax</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">] range&#39;</span><span class="p">)</span>

        <span class="c1">#### gaia catalog</span>
        <span class="c1"># get ideal coords into table</span>
        <span class="c1">#self.refcat.t[&#39;x_idl&#39;], self.refcat.t[&#39;y_idl&#39;] = radec_to_idl(self.refcat.t[self.refcat.racol], </span>
        <span class="c1">#                                                              self.refcat.t[self.refcat.deccol],</span>
        <span class="c1">#                                                              aperturename, </span>
        <span class="c1">#                                                              primaryhdr, scihdr)</span>
        <span class="c1">#xmin = self.refcat.t[&#39;x_idl&#39;].min()</span>
        <span class="c1">#xmax = self.refcat.t[&#39;x_idl&#39;].max()</span>
        <span class="c1">#ymin = self.refcat.t[&#39;y_idl&#39;].min()</span>
        <span class="c1">#ymax = self.refcat.t[&#39;y_idl&#39;].max()</span>
        <span class="c1">#print(f&#39;refcat objects are in x_idl=[{xmin:.2f},{xmax:.2f}] and y_idl=[{ymin:.2f},{ymax:.2f}] range&#39;)</span>

        <span class="c1"># cut down to the objects that are within the image</span>
        <span class="c1">#ixs_cat = self.refcat.ix_inrange(&#39;x_idl&#39;,xmin-max_sep,xmax+max_sep)</span>
        <span class="c1">#ixs_cat = self.refcat.ix_inrange(&#39;y_idl&#39;,ymin-max_sep,ymax+max_sep,indices=ixs_cat)</span>
        <span class="c1">#print(f&#39;Keeping {len(ixs_cat)} out of {len(self.refcat.getindices())} catalog objects&#39;)</span>
        <span class="c1">#ixs_cat = self.refcat.ix_not_null([self.refcat.racol,self.refcat.deccol],indices=ixs_cat)</span>
        <span class="c1">#print(f&#39;Keeping {len(ixs_cat)}  after removing NaNs from ra/dec&#39;)</span>
        
        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="n">world_to_detector</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">=</span> <span class="n">world_to_detector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">])</span>

        <span class="c1">#xmin = self.refcat.t[&#39;x&#39;].min()</span>
        <span class="c1">#xmax = self.refcat.t[&#39;x&#39;].max()</span>
        <span class="c1">#ymin = self.refcat.t[&#39;y&#39;].min()</span>
        <span class="c1">#ymax = self.refcat.t[&#39;y&#39;].max()</span>
        <span class="c1">#print(f&#39;refcat objects are in x=[{xmin:.2f},{xmax:.2f}] and y=[{ymin:.2f},{ymax:.2f}] range&#39;)</span>
        
        <span class="c1">#sys.exit(0)</span>

        <span class="c1"># cut down to the objects that are within the image</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">-</span><span class="n">borderpadding</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">borderpadding</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">-</span><span class="n">borderpadding</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">borderpadding</span>
        
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_cat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">getindices</span><span class="p">())</span><span class="si">}</span><span class="s1"> catalog objects within x=</span><span class="si">{</span><span class="n">xmin</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">xmax</span><span class="si">}</span><span class="s1"> and y=</span><span class="si">{</span><span class="n">ymin</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ymax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_not_null</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_cat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span><span class="si">}</span><span class="s1">  after removing NaNs from ra/dec&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!!!! 0 sources from reference catalog within the image bounderies! skipping the rest of the steps calculating x,y of the Gaia sources etc... &#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get the detector x,y position</span>
        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="n">world_to_detector</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">world_to_detector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">])</span>

        <span class="n">refcatcoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
    
        <span class="c1">#idx, d2d, _ = match_coordinates_sky(self.t.loc[ixs_obj,&#39;coord&#39;], self.refcat.t.loc[ixs_cat,&#39;coord&#39;])</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">objcoord</span><span class="p">,</span><span class="n">refcatcoord</span><span class="p">)</span>
        <span class="c1"># ixs_cat4obj has the same length as ixs_obj</span>
        <span class="c1"># for each object in ixs_obj, it contains the index to the self.refcat entry</span>
        <span class="n">ixs_cat4obj</span> <span class="o">=</span> <span class="n">ixs_cat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


        <span class="c1"># copy over the relevant columns from refcat. The columns are preceded with &#39;{refcatshort}_&#39;</span>
        <span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span><span class="p">)</span>
        <span class="n">cols2copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span><span class="p">)</span>
        <span class="n">cols2copy</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">cols2copy</span><span class="p">)</span>
        
        <span class="c1">#self.refcatshort = refcatshort</span>
        <span class="c1">#self.refcat_racol = None</span>
        <span class="c1">#self.refcat_deccol = None</span>
        <span class="k">for</span> <span class="n">refcat_col</span> <span class="ow">in</span> <span class="n">cols2copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">refcat_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to copy column </span><span class="si">{</span><span class="n">refcat_col</span><span class="si">}</span><span class="s1">, but this column is not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_ra&#39;</span>
                <span class="c1">#self.refcat_racol = f&#39;{refcatshort}_ra&#39;</span>
            <span class="k">elif</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_dec&#39;</span>
                <span class="c1">#self.refcat_deccol = f&#39;{refcatshort}_dec&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">refcat_col</span><span class="si">}</span><span class="s1">&#39;</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="n">obj_col</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat4obj</span><span class="p">,</span><span class="n">refcat_col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="s1">&#39;source_id&#39;</span><span class="p">:</span>
                <span class="c1">#print(&#39;############################################ converting source_id&#39;)</span>
                <span class="c1">#bla_ixs = self.ix_not_null(obj_col)</span>
                <span class="c1">#print(f&#39;XXXXXXX {len(bla_ixs)} {len(self.t[obj_col])}&#39;)</span>
                <span class="c1">#print(self.t[obj_col])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">obj_col</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">obj_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Int64Dtype</span><span class="p">())</span>
        <span class="c1"># also add d2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_d2d&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">d2d</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="c1">#self.refcat_xcol = f&#39;{refcatshort}_x&#39;</span>
        <span class="c1">#self.refcat_ycol = f&#39;{refcatshort}_y&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_important_refcatcols</span><span class="p">(</span><span class="n">refcatshort</span><span class="o">=</span><span class="n">refcatshort</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">get_photfilename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">photfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">outrootdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">outsubdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">imagename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">photfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">photfilename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">photfilename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imagename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;could not get photfilename from </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="n">photfilename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\.fits$&#39;</span><span class="p">,</span><span class="s1">&#39;.phot.txt&#39;</span><span class="p">,</span><span class="n">imagename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">photfilename</span> <span class="o">==</span> <span class="n">imagename</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;could not get photfilename from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">outrootdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">outsubdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">photfilename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outrootdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outdir</span><span class="o">=</span><span class="n">outrootdir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span>
            
            <span class="k">if</span> <span class="n">outsubdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outdir</span><span class="o">+=</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">outsubdir</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">photfilename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>
         
            
        <span class="k">return</span><span class="p">(</span><span class="n">photfilename</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">get_radecinfo_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">im</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span>
        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                
        <span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coord0</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>        
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>     
                <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                <span class="n">radius_deg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bbbbbbb&#39;</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">radius_deg</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">run_phot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imagename</span><span class="p">,</span> 
                 <span class="n">refcatname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">refcat_racol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">refcat_deccol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">refcat_magcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">refcat_colorcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">pmflag</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># apply proper motion</span>
                 <span class="n">pm_median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1"># if pm_median, then the median proper motion is added instead of the individual ones</span>
                 <span class="n">photfilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">outrootdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">outsubdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                
                 <span class="n">load_photcat_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">rematch_refcat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">use_dq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">DNunits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">SNR_min</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">do_photometry_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">photcat_loaded</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">Nbright4match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="c1"># added to the x coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                 <span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># added to the y coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                 <span class="n">ee_radius</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">### Doing photometry on </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ee_radius</span> <span class="o">=</span> <span class="n">ee_radius</span>
        <span class="c1"># get the photfilename. photfilename=&#39;auto&#39; removes fits from image name and replaces it with phot.txt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_photfilename</span><span class="p">(</span><span class="n">photfilename</span><span class="p">,</span><span class="n">outrootdir</span><span class="o">=</span><span class="n">outrootdir</span><span class="p">,</span><span class="n">outsubdir</span><span class="o">=</span><span class="n">outsubdir</span><span class="p">,</span><span class="n">imagename</span><span class="o">=</span><span class="n">imagename</span><span class="p">)</span>
        
        <span class="c1"># Load photcat if wanted</span>
        <span class="n">photcat_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;photometry catalog filename: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">load_photcat_if_exists</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;photcat </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="si">}</span><span class="s1"> already exists, loading it instead of recreating it&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="p">)</span>
                    <span class="n">photcat_loaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># skip redoing the photometry</span>
                    <span class="n">do_photometry_flag</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">elif</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;photcat </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="si">}</span><span class="s1"> already exists, but recreating it since overwrite=True&#39;</span><span class="p">)</span>
                    <span class="n">rmfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;photcat </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="si">}</span><span class="s1"> already exists, exiting! if you want to overwrite, use --overwrite option!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NO photometry catalog filename&#39;</span><span class="p">)</span>
        
        <span class="c1"># load the image, and prepare it. The data and mask are saved in </span>
        <span class="c1"># self.data and self.mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span><span class="n">DNunits</span><span class="o">=</span><span class="n">DNunits</span><span class="p">,</span><span class="n">use_dq</span><span class="o">=</span><span class="n">use_dq</span><span class="p">)</span>
        <span class="c1"># only do the photometry if not reloaded</span>
        <span class="k">if</span> <span class="n">do_photometry_flag</span><span class="p">:</span>
    
            <span class="c1"># find the stars, saved in self.found_stars</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_stars</span><span class="p">()</span>
            
            <span class="c1">#aperture phot, saved in self.t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aperture_phot</span><span class="p">()</span>
             
        
        <span class="c1"># get the indices of good stars</span>
        <span class="n">ixs_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_phottable</span><span class="p">(</span><span class="n">SNR_min</span><span class="o">=</span><span class="n">SNR_min</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_clean</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">())</span><span class="si">}</span><span class="s1"> entries remain in photometry table&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs_clean</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;NO  OBJECTS FOUND IN  IMAGE!!&#39;</span><span class="p">)</span>
        
        <span class="c1">#self.write(&#39;DELME0.txt&#39;,columns=[&#39;x&#39;,&#39;y&#39;,&#39;mag&#39;,&#39;dmag&#39;])</span>
        <span class="c1">#self.write(&#39;DELME1.txt&#39;,indices=ixs_clean,columns=[&#39;x&#39;,&#39;y&#39;,&#39;mag&#39;,&#39;dmag&#39;])</span>
        <span class="c1">#sys.exit(0)</span>
        
        <span class="k">if</span> <span class="n">Nbright4match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ixs_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix_sort_by_cols</span><span class="p">([</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_clean</span><span class="p">)</span>
            <span class="n">ixs_clean</span> <span class="o">=</span> <span class="n">ixs_sort</span><span class="p">[:</span><span class="n">Nbright4match</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;keeping the britghtest </span><span class="si">{</span><span class="n">Nbright4match</span><span class="si">}</span><span class="s1"> sources: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_clean</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">())</span><span class="si">}</span><span class="s1"> entries remain in photometry table&#39;</span><span class="p">)</span>
        
        <span class="c1"># calculate the ra,dec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_radec</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_clean</span><span class="p">,</span><span class="n">xshift</span><span class="o">=</span><span class="n">xshift</span><span class="p">,</span><span class="n">yshift</span><span class="o">=</span><span class="n">yshift</span><span class="p">)</span>
         
        <span class="c1"># calculate the ideal coordinates</span>
        <span class="c1">#self.radec_to_idl(indices=ixs_clean)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_idl</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_clean</span><span class="p">)</span>
        
        <span class="c1"># calculate the ideal coordinates</span>
        <span class="c1">#self.xy_to_idl(indices=ixs_clean,xcol_idl=&#39;x_idl_test&#39;,ycol_idl=&#39;y_idl_test&#39;)</span>
        
        <span class="c1"># get the refcat and match it, but only if either the photometry has </span>
        <span class="c1"># been done (not photcat_loaded), or if rematch_refcat is requested</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">refcatname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pmflag</span> <span class="ow">or</span> <span class="n">pm_median</span><span class="p">:</span> 
                <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;MJD-AVG&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rematch_refcat</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">photcat_loaded</span><span class="p">)):</span>
                <span class="p">(</span><span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_radecinfo_image</span><span class="p">()</span>
                <span class="n">radius_deg</span> <span class="o">*=</span><span class="mf">2.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Getting </span><span class="si">{</span><span class="n">refcatname</span><span class="si">}</span><span class="s1"> and matching it: ra=</span><span class="si">{</span><span class="n">ra0</span><span class="si">}</span><span class="s1"> dec=</span><span class="si">{</span><span class="n">dec0</span><span class="si">}</span><span class="s1"> radius=</span><span class="si">{</span><span class="n">radius_deg</span><span class="si">}</span><span class="s1"> deg&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_refcat</span><span class="p">(</span><span class="n">refcatname</span><span class="p">,</span>
                                 <span class="n">ra0</span><span class="p">,</span><span class="n">dec0</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">,</span>
                                 <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                                 <span class="n">pm_median</span><span class="o">=</span><span class="n">pm_median</span><span class="p">,</span>
                                 <span class="n">refcat_racol</span><span class="o">=</span><span class="n">refcat_racol</span><span class="p">,</span>
                                 <span class="n">refcat_deccol</span><span class="o">=</span><span class="n">refcat_deccol</span><span class="p">,</span>
                                 <span class="n">refcat_magcol</span><span class="o">=</span><span class="n">refcat_magcol</span><span class="p">,</span>
                                 <span class="n">refcat_magerrcol</span><span class="o">=</span><span class="n">refcat_magerrcol</span><span class="p">,</span>
                                 <span class="n">refcat_colorcol</span><span class="o">=</span><span class="n">refcat_colorcol</span><span class="p">)</span>
                <span class="c1">#self.refcat.write(&#39;DELMErefcat.txt&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match_refcat</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_clean</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># set refcat parameters like refcat.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_refcat</span><span class="p">(</span><span class="n">refcatname</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                                 <span class="n">refcat_racol</span><span class="o">=</span><span class="n">refcat_racol</span><span class="p">,</span>
                                 <span class="n">refcat_deccol</span><span class="o">=</span><span class="n">refcat_deccol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_important_refcatcols</span><span class="p">()</span>
                
        
        <span class="c1">#self.write(self.get_photfilename()+&#39;.all&#39;)</span>
        <span class="c1"># save the catalog</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_clean</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photfilename</span><span class="p">)</span></div>

<div class="viewcode-block" id="hst_photclass"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.hst_photclass">[docs]</a><span class="k">class</span> <span class="nc">hst_photclass</span><span class="p">(</span><span class="n">jwst_photclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The photometry class for HST images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psf_fwhm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for HST photometry class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psf_fwhm : float</span>
<span class="sd">            PSF FWHM for image</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hst_photclass : :class:`~jhat.hst_photclass`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">stsci.skypac</span> <span class="kn">import</span> <span class="n">pamutils</span>


        <span class="n">jwst_photclass</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="n">instrument</span> <span class="p">:</span> <span class="p">[</span><span class="n">image_filter</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">{</span><span class="n">instrument</span> <span class="p">:</span> <span class="p">[</span><span class="n">psf_fwhm</span><span class="p">]}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">instrument</span><span class="p">]))}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtername</span> <span class="o">=</span> <span class="n">image_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subarray</span> <span class="o">=</span> <span class="n">subarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="n">aperture_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span> <span class="o">=</span> <span class="n">aperture_radius</span>

    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">imagetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DNunits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_dq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">skip_preparing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">imagename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_plane_pixel_scales</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">*</span>\
         <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Instrument: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s1">, aperture:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">imagetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;flt\.fits$|flc\.fits$|tweakregstep\.fits$|assignwcsstep\.fits$&#39;</span><span class="p">,</span><span class="n">imagename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="s1">&#39;flc&#39;</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;drz\.fits$|drc\.fits$&#39;</span><span class="p">,</span><span class="n">imagename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="s1">&#39;drz&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown image type for file </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">=</span> <span class="n">imagetype</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_preparing</span><span class="p">:</span>
            <span class="c1"># prepare the data.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">==</span> <span class="s1">&#39;flc&#39;</span><span class="p">:</span>
                <span class="c1">#print(&#39;VVVVV&#39;,self.im.info())</span>
                <span class="c1">#sys.exit(0)</span>
                <span class="n">dq</span><span class="o">=</span><span class="kc">None</span>
                <span class="k">if</span> <span class="n">use_dq</span><span class="p">:</span> 
                    <span class="n">dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;DQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using DQ extension!!&#39;</span><span class="p">)</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                                                           <span class="n">area</span> <span class="o">=</span> <span class="n">pamutils</span><span class="o">.</span><span class="n">pam_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;_pam.fits&#39;</span><span class="p">),</span>
                                                           <span class="n">dq</span> <span class="o">=</span> <span class="n">dq</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span> <span class="o">==</span> <span class="s1">&#39;drz&#39;</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imagetype</span><span class="si">}</span><span class="s1"> not yet implemented!&#39;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_original</span><span class="p">,</span> <span class="n">imhdr</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">dq_ignore_bits</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># dq_ignore_bits contains the bits in the dq which are still ok, so they</span>
        <span class="c1"># should be ignored.</span>
        <span class="c1"># 2 = Pixel saturated during integration</span>
        <span class="c1"># 4 = Jump detected during integration</span>
        
        <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying Pixel Area Map&#39;</span><span class="p">)</span>
        
            <span class="n">data_pam</span> <span class="o">=</span> <span class="n">data_original</span> <span class="o">*</span> <span class="n">area</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">data_pam</span> <span class="o">=</span> <span class="n">data_original</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_pam</span>
        
        
        <span class="k">if</span> <span class="n">dq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># dq_ignore_bits are removed from the mask!</span>
            <span class="c1">#fits.writeto(&#39;TEST_dq_delme.fits&#39;,dq,overwrite=True,output_verify=&#39;ignore&#39;)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">~</span><span class="n">dq_ignore_bits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># hijack a few bits for our purposes...</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="c1">#fits.writeto(&#39;TEST_mask_delme.fits&#39;,mask,overwrite=True,output_verify=&#39;ignore&#39;)</span>
               
        <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">mask</span>


<div class="viewcode-block" id="hst_photclass.aperture_phot"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.hst_photclass.aperture_phot">[docs]</a>    <span class="k">def</span> <span class="nf">aperture_phot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pupil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radii_Nfwhm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">radius_Nfwhm_sky_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radius_Nfwhm_sky_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">radius_Nfwhm_for_mag</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aperture photometry routine for HST.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        table_aper : :class:`astropy.table.Table`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>

        <span class="k">if</span> <span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;ELECTRON&#39;</span><span class="p">:</span>
            <span class="n">epadu</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epadu</span> <span class="o">=</span> <span class="n">primaryhdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="n">hst_get_zp</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="s1">&#39;ir&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="s1">&#39;uvis&#39;</span>
        <span class="k">if</span> <span class="n">radii_Nfwhm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span> <span class="o">=</span> <span class="n">radii_Nfwhm</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_utils</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">filtername</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span> <span class="o">=</span> <span class="n">hst_get_ee_corr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">filtername</span><span class="p">,</span><span class="n">inst</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="o">*</span><span class="mi">5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_for_mag_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;radii:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="si">}</span><span class="s1">pixels radius_sky_in:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="si">}</span><span class="s1"> radius_sky_out:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span><span class="si">}</span><span class="s1">  radius_for_mag:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_for_mag_px</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
        
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
        <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii_px</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing aperture photometry for radius r = </span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s1"> px&#39;</span><span class="p">)</span>
            <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
            
            <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> 
                                               <span class="n">r_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_in_px</span><span class="p">,</span> 
                                               <span class="n">r_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_sky_out_px</span><span class="p">)</span>
            <span class="n">annulus_masks</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
            <span class="n">local_sky_median</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">local_sky_stdev</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">annulus_mask</span> <span class="ow">in</span> <span class="n">annulus_masks</span><span class="p">:</span>
                
                <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">annulus_mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">annulus_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">annulus_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
                    <span class="n">mean_sigclip</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">,</span> 
                                                                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mean_sigclip</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">median_sigclip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">median_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.99</span>
                        <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.99</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">median_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.99</span>
                    <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.99</span>
                
                <span class="n">local_sky_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
                <span class="n">local_sky_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_sigclip</span><span class="p">)</span>
            
            <span class="n">local_sky_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_sky_median</span><span class="p">)</span>
            <span class="n">local_sky_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_sky_stdev</span><span class="p">)</span>
            
<span class="c1">#            if select_dq:        </span>
<span class="c1">#                </span>
<span class="c1">#                phot = aperture_photometry(data, aperture, method=&#39;exact&#39;)</span>
            
<span class="c1">#            else:</span>
                
<span class="c1">#                zero_mask = np.where(data == 0,0,1)</span>
<span class="c1">#                nan_mask  = np.where(np.isnan(data),0,1)</span>
<span class="c1">#                zero_mask = nan_mask * zero_mask</span>
<span class="c1">#        </span>
<span class="c1">#                nan_mask = np.where(zero_mask == 0,True,False)</span>
            <span class="n">boolmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bool_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            
            <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span><span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">boolmask</span><span class="p">)</span>
            
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_sky_median</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_sky_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_poisson</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])</span>
                <span class="n">error_scatter_sky</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">local_sky_stdev</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">error_mean_sky</span> <span class="o">=</span> <span class="n">local_sky_stdev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">area</span>
                <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_poisson</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">epadu</span> <span class="o">+</span> <span class="n">error_scatter_sky</span> <span class="o">+</span> <span class="n">error_mean_sky</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">]</span>
            
            
        
            
            <span class="n">ee_corr</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">inst</span><span class="o">==</span><span class="s1">&#39;uvis&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hdr</span> <span class="o">=</span> <span class="n">scihdr</span>
                    <span class="n">photflam</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PHOTFLAM&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hdr</span> <span class="o">=</span> <span class="n">primaryhdr</span>
                    <span class="n">photflam</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PHOTFLAM&#39;</span><span class="p">]</span>
                <span class="n">photplam</span> <span class="o">=</span> <span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;PHOTPLAM&#39;</span><span class="p">]</span>
                <span class="n">zp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photflam</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photplam</span><span class="p">)</span><span class="o">-</span><span class="mf">2.408</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">ee_corr</span><span class="o">+</span><span class="n">zp</span>                
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span><span class="o">/=</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span>
            <span class="n">fluxerr</span><span class="o">/=</span><span class="bp">self</span><span class="o">.</span><span class="n">apcorr</span>
            <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">fluxerr</span><span class="o">/</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]))</span>

            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_sum&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colname</span><span class="p">(</span><span class="s1">&#39;flux_err&#39;</span><span class="p">,</span><span class="n">rad</span><span class="p">))</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>
            <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dmag&#39;</span><span class="p">)</span>

            <span class="c1">#if rad == self.radius_for_mag_px:</span>
                <span class="c1">#table_aper[&#39;mag&#39;] = -2.5 * np.log10(table_aper[self.colname(&#39;aper_sum_bkgsub&#39;,rad)])</span>
                <span class="c1">#table_aper[&#39;dmag&#39;] = 1.086 * (table_aper[self.colname(&#39;flux_err&#39;,rad)] / </span>
                <span class="c1">#                              table_aper[self.colname(&#39;aper_sum_bkgsub&#39;,rad)])      </span>

        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;roundness1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness1&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span>
        <span class="n">table_aper</span> <span class="o">=</span> <span class="n">table_aper</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">table_aper</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">])]</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">table_aper</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">table_aper</span></div>

    <span class="k">def</span> <span class="nf">xy_to_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">racol</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">deccol</span><span class="o">=</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">xshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">yshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        
        <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">xcol</span><span class="p">]</span><span class="o">+</span><span class="n">xshift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">ycol</span><span class="p">]</span><span class="o">+</span><span class="n">yshift</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">racol</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span><span class="n">deccol</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span>

    <span class="k">def</span> <span class="nf">xy_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ycol</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">xcol_idl</span><span class="o">=</span><span class="s1">&#39;x_idl&#39;</span><span class="p">,</span> <span class="n">ycol_idl</span><span class="o">=</span><span class="s1">&#39;y_idl&#39;</span><span class="p">,</span>
                     <span class="n">aperturename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">primaryhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scihdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">primaryhdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">primaryhdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primaryhdr</span>
        <span class="k">if</span> <span class="n">scihdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scihdr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span>
    
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getindices</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol</span><span class="p">])</span>
        <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span> <span class="o">=</span> <span class="n">xy_to_idl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol</span><span class="p">],</span> 
                                      <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">ycol</span><span class="p">],</span>
                                      <span class="n">primaryhdr</span><span class="p">,</span> <span class="n">scihdr</span><span class="p">,</span>
                                      <span class="n">aperturename</span> <span class="o">=</span> <span class="s1">&#39;APERTURE&#39;</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">,</span>
                                      <span class="n">pysiaf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">xcol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">x_idl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="n">ycol_idl</span><span class="p">]</span><span class="o">=</span><span class="n">y_idl</span>
  
        <span class="k">return</span> <span class="n">x_idl</span><span class="p">,</span> <span class="n">y_idl</span>

    <span class="k">def</span> <span class="nf">get_radecinfo_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">im</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span>
        <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                
        <span class="n">coord0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ny</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>        
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>     
                <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                <span class="n">radius_deg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">radius_deg</span><span class="p">)</span>

        
        <span class="k">return</span><span class="p">(</span><span class="n">coord0</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span><span class="n">coord0</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span><span class="n">radius_deg</span><span class="p">)</span>



<div class="viewcode-block" id="hst_photclass.match_refcat"><a class="viewcode-back" href="../../api.html#jhat.simple_jwst_phot.hst_photclass.match_refcat">[docs]</a>    <span class="k">def</span> <span class="nf">match_refcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">max_sep</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">borderpadding</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                     <span class="n">refcatshort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="c1">#aperturename=None,</span>
                     <span class="c1">#primaryhdr=None, </span>
                     <span class="c1">#scihdr=None,</span>
                     <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches the photometry catalog to the reference catalog.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_sep : float</span>
<span class="sd">            Maximum separation between sources in arcseconds</span>
<span class="sd">        borderpadding : float</span>
<span class="sd">            Pixel separation required from border of image</span>
<span class="sd">        refcatshort : string, optional</span>
<span class="sd">            Short name of reference catalog that is used as prefix for the column names. The default is None.</span>
<span class="sd">            If None, then refcatshort is set to self.refcat.short</span>
<span class="sd">        indices : list</span>
<span class="sd">            The indices to access the photometry catalog, default None (use the full catalog)</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matching reference catalog </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">refcatshort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">refcatshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">short</span>

        <span class="c1">#if primaryhdr is None: primaryhdr=self.primaryhdr</span>
        <span class="c1">#if scihdr is None: scihdr=self.scihdr</span>
        
        <span class="c1">#if aperturename is None:</span>
        <span class="c1">#    aperturename = self.aperture</span>

        <span class="c1"># make sure there are no NaNs        </span>
        <span class="n">ixs_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix_not_null</span><span class="p">([</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="c1"># get SkyCoord objects (needed for matching)</span>
        <span class="n">objcoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

        
        <span class="c1"># find the x_idl and y_idl range, so that we can cut down the objects from the outside catalog!!</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;x_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;x_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;y_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="s1">&#39;y_idl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image objects are in x_idl=[</span><span class="si">{</span><span class="n">xmin</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">xmax</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">] and y_idl=[</span><span class="si">{</span><span class="n">ymin</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">ymax</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">] range&#39;</span><span class="p">)</span>

        <span class="c1">#### gaia catalog</span>
        <span class="c1"># get ideal coords into table</span>
        <span class="c1">#self.refcat.t[&#39;x_idl&#39;], self.refcat.t[&#39;y_idl&#39;] = radec_to_idl(self.refcat.t[self.refcat.racol], </span>
        <span class="c1">#                                                              self.refcat.t[self.refcat.deccol],</span>
        <span class="c1">#                                                              aperturename, </span>
        <span class="c1">#                                                              primaryhdr, scihdr)</span>
        <span class="c1">#xmin = self.refcat.t[&#39;x_idl&#39;].min()</span>
        <span class="c1">#xmax = self.refcat.t[&#39;x_idl&#39;].max()</span>
        <span class="c1">#ymin = self.refcat.t[&#39;y_idl&#39;].min()</span>
        <span class="c1">#ymax = self.refcat.t[&#39;y_idl&#39;].max()</span>
        <span class="c1">#print(f&#39;refcat objects are in x_idl=[{xmin:.2f},{xmax:.2f}] and y_idl=[{ymin:.2f},{ymax:.2f}] range&#39;)</span>

        <span class="c1"># cut down to the objects that are within the image</span>
        <span class="c1">#ixs_cat = self.refcat.ix_inrange(&#39;x_idl&#39;,xmin-max_sep,xmax+max_sep)</span>
        <span class="c1">#ixs_cat = self.refcat.ix_inrange(&#39;y_idl&#39;,ymin-max_sep,ymax+max_sep,indices=ixs_cat)</span>
        <span class="c1">#print(f&#39;Keeping {len(ixs_cat)} out of {len(self.refcat.getindices())} catalog objects&#39;)</span>
        <span class="c1">#ixs_cat = self.refcat.ix_not_null([self.refcat.racol,self.refcat.deccol],indices=ixs_cat)</span>
        <span class="c1">#print(f&#39;Keeping {len(ixs_cat)}  after removing NaNs from ra/dec&#39;)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span>
                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span>
                                                                                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="c1">#xmin = self.refcat.t[&#39;x&#39;].min()</span>
        <span class="c1">#xmax = self.refcat.t[&#39;x&#39;].max()</span>
        <span class="c1">#ymin = self.refcat.t[&#39;y&#39;].min()</span>
        <span class="c1">#ymax = self.refcat.t[&#39;y&#39;].max()</span>
        <span class="c1">#print(f&#39;refcat objects are in x=[{xmin:.2f},{xmax:.2f}] and y=[{ymin:.2f},{ymax:.2f}] range&#39;)</span>
        
        <span class="c1">#sys.exit(0)</span>

        <span class="c1"># cut down to the objects that are within the image</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">-</span><span class="n">borderpadding</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">borderpadding</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">-</span><span class="n">borderpadding</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scihdr</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">borderpadding</span>
        
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_inrange</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_cat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">getindices</span><span class="p">())</span><span class="si">}</span><span class="s1"> catalog objects within x=</span><span class="si">{</span><span class="n">xmin</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">xmax</span><span class="si">}</span><span class="s1"> and y=</span><span class="si">{</span><span class="n">ymin</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ymax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ixs_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">ix_not_null</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span><span class="n">indices</span><span class="o">=</span><span class="n">ixs_cat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span><span class="si">}</span><span class="s1">  after removing NaNs from ra/dec&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs_cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!!!! 0 Gaia sources from catalog within the image bounderies! skipping the rest of the steps calculating x,y of the Gaia sources etc... &#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get the detector x,y position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sci_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span>
                                                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span>
                                                                                                            <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="n">refcatcoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
    
        <span class="c1">#idx, d2d, _ = match_coordinates_sky(self.t.loc[ixs_obj,&#39;coord&#39;], self.refcat.t.loc[ixs_cat,&#39;coord&#39;])</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">objcoord</span><span class="p">,</span><span class="n">refcatcoord</span><span class="p">)</span>
        <span class="c1"># ixs_cat4obj has the same length as ixs_obj</span>
        <span class="c1"># for each object in ixs_obj, it contains the index to the self.refcat entry</span>
        <span class="n">ixs_cat4obj</span> <span class="o">=</span> <span class="n">ixs_cat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


        <span class="c1"># copy over the relevant columns from refcat. The columns are preceded with &#39;{refcatshort}_&#39;</span>
        <span class="n">cols2copy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">mainfilter_err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols2copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">maincolor</span><span class="p">)</span>
        <span class="n">cols2copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">cols2copy</span><span class="p">)</span>
        <span class="n">cols2copy</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">cols2copy</span><span class="p">)</span>

        <span class="c1">#self.refcatshort = refcatshort</span>
        <span class="c1">#self.refcat_racol = None</span>
        <span class="c1">#self.refcat_deccol = None</span>
        <span class="k">for</span> <span class="n">refcat_col</span> <span class="ow">in</span> <span class="n">cols2copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">refcat_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to copy column </span><span class="si">{</span><span class="n">refcat_col</span><span class="si">}</span><span class="s1">, but this column is not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">racol</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_ra&#39;</span>
                <span class="c1">#self.refcat_racol = f&#39;{refcatshort}_ra&#39;</span>
            <span class="k">elif</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">deccol</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_dec&#39;</span>
                <span class="c1">#self.refcat_deccol = f&#39;{refcatshort}_dec&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">refcat_col</span><span class="si">}</span><span class="s1">&#39;</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="n">obj_col</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refcat</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_cat4obj</span><span class="p">,</span><span class="n">refcat_col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">refcat_col</span> <span class="o">==</span> <span class="s1">&#39;source_id&#39;</span><span class="p">:</span>
                <span class="c1">#print(&#39;############################################ converting source_id&#39;)</span>
                <span class="c1">#bla_ixs = self.ix_not_null(obj_col)</span>
                <span class="c1">#print(f&#39;XXXXXXX {len(bla_ixs)} {len(self.t[obj_col])}&#39;)</span>
                <span class="c1">#print(self.t[obj_col])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">obj_col</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">obj_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Int64Dtype</span><span class="p">())</span>
        <span class="c1"># also add d2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixs_obj</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">refcatshort</span><span class="si">}</span><span class="s1">_d2d&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">d2d</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="c1">#self.refcat_xcol = f&#39;{refcatshort}_x&#39;</span>
        <span class="c1">#self.refcat_ycol = f&#39;{refcatshort}_y&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_important_refcatcols</span><span class="p">(</span><span class="n">refcatshort</span><span class="o">=</span><span class="n">refcatshort</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>
    

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">phot</span> <span class="o">=</span> <span class="n">jwst_photclass</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">define_options</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">is_hst</span><span class="p">:</span>
        <span class="n">phot</span> <span class="o">=</span> <span class="n">hst_photclass</span><span class="p">()</span>

    <span class="n">phot</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    
    <span class="n">phot</span><span class="o">.</span><span class="n">run_phot</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                  <span class="n">refcatname</span><span class="o">=</span><span class="s1">&#39;./LMC_gaia_DR3.nrcposs&#39;</span><span class="p">,</span>
                  <span class="n">photfilename</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">photfilename</span><span class="p">,</span>
                  <span class="n">outrootdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outrootdir</span><span class="p">,</span>
                  <span class="n">outsubdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outsubdir</span><span class="p">,</span>
                  <span class="n">overwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                  <span class="n">load_photcat_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">DNunits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">use_dq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">SNR_min</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">SNR_min</span><span class="p">,</span>
                  <span class="n">xshift</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xshift</span><span class="p">,</span><span class="c1"># added to the x coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                  <span class="n">yshift</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">yshift</span><span class="p">,</span> <span class="c1"># added to the y coordinate before calculating ra,dec. This can be used to correct for large shifts before matching!</span>
                  <span class="n">ee_radius</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ee_radius</span>
                  <span class="p">)</span>
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 Armin Rest &amp; Justin Pierel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>